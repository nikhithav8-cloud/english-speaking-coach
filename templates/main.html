<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gayathri Speak Smart</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Fredoka+One&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Nunito', 'Comic Sans MS', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; justify-content: center; align-items: flex-start; padding: 20px; position: relative; overflow-x: hidden; }

        .exit-btn { position: fixed; top: 20px; left: 20px; padding: 12px 24px; background: linear-gradient(135deg, #ff7675 0%, #d63031 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: 800; cursor: pointer; box-shadow: 0 5px 15px rgba(214,48,49,.4); transition: all .3s; z-index: 1000; display: flex; align-items: center; gap: 8px; }
        .exit-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(214,48,49,.6); }
        .badges-toggle-btn { position: fixed; top: 20px; right: 20px; padding: 12px 20px; background: linear-gradient(135deg, #ffd700 0%, #f39c12 100%); color: #2d3436; border: none; border-radius: 12px; font-size: 15px; font-weight: 800; cursor: pointer; box-shadow: 0 5px 15px rgba(243,156,18,.4); transition: all .3s; z-index: 1000; display: flex; align-items: center; gap: 8px; }
        .badges-toggle-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(243,156,18,.6); }
        .badge-count-bubble { background: #e17055; color: white; border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 900; }
        .leaderboard-btn { position: fixed; top: 70px; right: 20px; padding: 10px 16px; background: linear-gradient(135deg, #6c5ce7, #a29bfe); color: white; border: none; border-radius: 12px; font-size: 14px; font-weight: 800; cursor: pointer; box-shadow: 0 5px 15px rgba(108,92,231,.4); transition: all .3s; z-index: 1000; }
        .leaderboard-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(108,92,231,.6); }

        /* ===== DAILY CHALLENGE MODAL ===== */
        .daily-modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,.75); z-index: 3000; backdrop-filter: blur(6px); align-items: center; justify-content: center; }
        .daily-modal-overlay.open { display: flex; }
        .daily-modal { background: white; border-radius: 28px; padding: 0; max-width: 560px; width: 95%; max-height: 90vh; overflow-y: auto; box-shadow: 0 30px 80px rgba(0,0,0,.5); animation: dailyPop .4s cubic-bezier(.175,.885,.32,1.275); position: relative; }
        @keyframes dailyPop { from{transform:scale(.7) translateY(40px);opacity:0;} to{transform:scale(1) translateY(0);opacity:1;} }
        .daily-modal-header { background: linear-gradient(135deg, #00b894, #00cec9); padding: 28px 28px 22px; border-radius: 28px 28px 0 0; text-align: center; position: relative; }
        .daily-modal-close { position: absolute; top: 14px; right: 16px; background: rgba(255,255,255,.25); color: white; border: none; border-radius: 50%; width: 34px; height: 34px; font-size: 18px; cursor: pointer; font-weight: bold; }
        .daily-modal-close:hover { background: rgba(255,255,255,.45); }
        .daily-modal-title { color: white; font-size: 24px; font-weight: 900; margin-bottom: 4px; }
        .daily-modal-subtitle { color: rgba(255,255,255,.85); font-size: 14px; }
        .daily-modal-body { padding: 24px 26px 28px; }
        .daily-steps { display: flex; gap: 0; margin-bottom: 24px; background: #f5f5f5; border-radius: 14px; padding: 4px; }
        .daily-step { flex: 1; text-align: center; padding: 10px 6px; border-radius: 11px; font-size: 12px; font-weight: 700; color: #999; transition: all .3s; }
        .daily-step.active { background: linear-gradient(135deg, #00b894, #00cec9); color: white; box-shadow: 0 4px 12px rgba(0,184,148,.35); }
        .daily-step.done { background: linear-gradient(135deg, #55efc4, #00b894); color: white; }
        .challenge-card { background: linear-gradient(135deg, #f0fff8, #e0f9f0); border: 3px solid #00b894; border-radius: 16px; padding: 20px 22px; margin-bottom: 18px; text-align: center; }
        .challenge-card-label { font-size: 11px; font-weight: 900; text-transform: uppercase; letter-spacing: 1.5px; color: #00b894; margin-bottom: 10px; }
        .challenge-card-content { font-size: 22px; font-weight: 900; color: #2d3436; line-height: 1.4; margin-bottom: 12px; }
        .challenge-card-content.word-display { font-size: 34px; letter-spacing: 4px; color: #00b894; text-transform: uppercase; }
        .listen-btn { background: linear-gradient(135deg, #74b9ff, #a29bfe); color: white; border: none; border-radius: 10px; padding: 9px 20px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all .3s; }
        .listen-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(116,185,255,.4); }
        .daily-record-btn { width: 100%; padding: 15px; border: none; border-radius: 14px; font-size: 17px; font-weight: 900; cursor: pointer; transition: all .3s; background: linear-gradient(135deg, #667eea, #764ba2); color: white; box-shadow: 0 5px 15px rgba(102,126,234,.4); margin-top: 8px; }
        .daily-record-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(102,126,234,.5); }
        .daily-record-btn.recording { background: linear-gradient(135deg, #ff7675, #d63031); animation: pulse 1.5s infinite; }
        .daily-record-btn:disabled { background: #b2bec3; cursor: not-allowed; box-shadow: none; transform: none; }
        .daily-result { border-radius: 12px; padding: 14px 18px; margin-top: 14px; font-size: 15px; font-weight: bold; text-align: center; display: none; animation: slideIn .4s ease-out; }
        .daily-result.success { background: linear-gradient(135deg,#55efc4,#00b894); color: white; }
        .daily-result.partial { background: linear-gradient(135deg,#ffeaa7,#fdcb6e); color: #2d3436; }
        .daily-result.retry   { background: linear-gradient(135deg,#ff7675,#d63031); color: white; }
        .daily-next-btn { width: 100%; padding: 15px; border: none; border-radius: 14px; font-size: 17px; font-weight: 900; cursor: pointer; transition: all .3s; background: linear-gradient(135deg, #00b894, #00cec9); color: white; box-shadow: 0 5px 15px rgba(0,184,148,.4); margin-top: 12px; display: none; }
        .daily-next-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,184,148,.5); }
        .daily-reward-box { background: linear-gradient(135deg, #ffeaa7, #fdcb6e); border: 3px solid #f39c12; border-radius: 18px; padding: 26px 22px; text-align: center; margin-bottom: 18px; }
        .daily-reward-xp { font-size: 52px; font-weight: 900; background: linear-gradient(135deg,#f39c12,#e17055); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .daily-reward-label { font-size: 17px; font-weight: bold; color: #2d3436; margin-top: 4px; }
        .daily-claim-btn { width: 100%; padding: 17px; border: none; border-radius: 14px; font-size: 19px; font-weight: 900; cursor: pointer; transition: all .3s; background: linear-gradient(135deg, #f39c12, #e17055); color: white; box-shadow: 0 5px 20px rgba(243,156,18,.5); animation: claimPulse 1.5s ease-in-out infinite; }
        @keyframes claimPulse { 0%,100%{box-shadow:0 5px 20px rgba(243,156,18,.5);} 50%{box-shadow:0 8px 30px rgba(243,156,18,.8);transform:scale(1.02);} }
        .daily-sound-wave { display:none; justify-content:center; align-items:center; gap:5px; margin:10px 0; }
        .daily-sound-wave.active { display:flex; }
        .daily-wave-bar { width:5px; height:22px; background:linear-gradient(180deg,#667eea,#764ba2); border-radius:3px; animation:wave 1s ease-in-out infinite; }
        .daily-wave-bar:nth-child(1){animation-delay:0s} .daily-wave-bar:nth-child(2){animation-delay:.1s} .daily-wave-bar:nth-child(3){animation-delay:.2s} .daily-wave-bar:nth-child(4){animation-delay:.3s} .daily-wave-bar:nth-child(5){animation-delay:.4s}

        /* ===== BADGES PANEL ===== */
        .badges-panel-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,.7); z-index: 2000; backdrop-filter: blur(4px); }
        .badges-panel-overlay.open { display: flex; align-items: center; justify-content: center; }
        .badges-panel { background: white; border-radius: 25px; padding: 35px; max-width: 750px; width: 95%; max-height: 85vh; overflow-y: auto; position: relative; box-shadow: 0 25px 70px rgba(0,0,0,.4); animation: panelPop .4s ease-out; }
        @keyframes panelPop { from{transform:scale(.7);opacity:0;} to{transform:scale(1);opacity:1;} }
        .badges-panel-close { position: absolute; top: 15px; right: 20px; background: linear-gradient(135deg,#ff7675,#d63031); color: white; border: none; border-radius: 50%; width: 38px; height: 38px; font-size: 20px; cursor: pointer; font-weight: bold; }
        .badges-panel h2 { text-align: center; background: linear-gradient(135deg,#ffd700,#f39c12); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-size: 32px; margin-bottom: 8px; }
        .badges-panel-subtitle { text-align: center; color: #666; font-size: 16px; margin-bottom: 20px; }
        .badge-progress-bar-wrap { background: #eee; border-radius: 20px; height: 14px; margin-bottom: 25px; overflow: hidden; }
        .badge-progress-bar-fill { height: 100%; background: linear-gradient(90deg,#ffd700,#f39c12); border-radius: 20px; transition: width .8s ease; }
        .badge-category-title { font-size: 18px; font-weight: 900; color: #2d3436; margin: 20px 0 12px; padding-left: 10px; border-left: 5px solid #ffd700; }
        .badge-grid { display: grid; grid-template-columns: repeat(auto-fill,minmax(130px,1fr)); gap: 14px; margin-bottom: 10px; }
        .badge-card { background: linear-gradient(135deg,#f0f0f0,#e0e0e0); border: 3px solid #ccc; border-radius: 16px; padding: 18px 10px; text-align: center; transition: all .35s; position: relative; filter: grayscale(80%); opacity: .6; }
        .badge-card.earned { background: linear-gradient(135deg,#fffbe6,#fff3cd); border-color: #ffd700; filter: grayscale(0%); opacity: 1; box-shadow: 0 6px 20px rgba(255,215,0,.4); animation: badgeGlow 2s ease-in-out infinite alternate; }
        @keyframes badgeGlow { from{box-shadow:0 6px 20px rgba(255,215,0,.3);} to{box-shadow:0 8px 28px rgba(255,215,0,.7);} }
        .badge-card:hover { transform: translateY(-4px) scale(1.04); }
        .badge-card-icon { font-size: 38px; display: block; margin-bottom: 8px; }
        .badge-card-name { font-size: 13px; font-weight: 900; color: #2d3436; margin-bottom: 4px; }
        .badge-card-desc { font-size: 11px; color: #636e72; line-height: 1.3; }
        .badge-card-date { font-size: 10px; color: #00b894; font-weight: bold; margin-top: 5px; }
        .badge-card .badge-locked-icon { position: absolute; top: 8px; right: 8px; font-size: 14px; opacity: .5; }
        .badge-card.earned .badge-locked-icon { display: none; }
        .badge-toast-container { position: fixed; top: 80px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .badge-toast { background: linear-gradient(135deg,#ffd700,#f39c12); color: #2d3436; padding: 16px 22px; border-radius: 16px; font-size: 16px; font-weight: 900; box-shadow: 0 10px 30px rgba(243,156,18,.5); animation: toastSlide .5s ease-out, toastFade .5s ease-out 3.5s forwards; display: flex; align-items: center; gap: 12px; min-width: 230px; }
        .badge-toast-icon { font-size: 30px; }
        .badge-toast-text { line-height: 1.3; }
        .badge-toast-title { font-size: 12px; font-weight: bold; text-transform: uppercase; color: #e17055; }
        @keyframes toastSlide { from{transform:translateX(110%);opacity:0;} to{transform:translateX(0);opacity:1;} }
        @keyframes toastFade  { from{opacity:1;} to{opacity:0;pointer-events:none;} }

        /* ===== ROLEPLAY SWITCH TOAST ===== */
        .roleplay-switch-toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #6c5ce7, #a29bfe); color: white; padding: 14px 28px; border-radius: 50px; font-size: 16px; font-weight: 900; box-shadow: 0 10px 30px rgba(108,92,231,.5); z-index: 9999; animation: toastRise .4s ease-out, toastFade .5s ease-out 2.5s forwards; display: flex; align-items: center; gap: 10px; white-space: nowrap; }
        @keyframes toastRise { from{transform:translateX(-50%) translateY(40px);opacity:0;} to{transform:translateX(-50%) translateY(0);opacity:1;} }

        /* ===== LEADERBOARD ===== */
        .leaderboard-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,.7); z-index: 2000; backdrop-filter: blur(4px); }
        .leaderboard-overlay.open { display: flex; align-items: center; justify-content: center; }
        .leaderboard-panel { background: white; border-radius: 25px; padding: 35px; max-width: 500px; width: 95%; max-height: 80vh; overflow-y: auto; position: relative; box-shadow: 0 25px 70px rgba(0,0,0,.4); animation: panelPop .4s ease-out; }
        .leaderboard-panel h2 { text-align:center; background:linear-gradient(135deg,#6c5ce7,#a29bfe); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; font-size:28px; margin-bottom:20px; }
        .leaderboard-row { display:flex; align-items:center; padding:12px 16px; border-radius:12px; margin-bottom:8px; gap:14px; font-weight:bold; transition:all .3s; }
        .leaderboard-row:hover { transform:translateX(4px); }
        .leaderboard-row.top1 { background:linear-gradient(135deg,#ffd700,#ffed4e);color:#2d3436; }
        .leaderboard-row.top2 { background:linear-gradient(135deg,#dfe6e9,#b2bec3);color:#2d3436; }
        .leaderboard-row.top3 { background:linear-gradient(135deg,#fdcb6e,#e17055);color:white; }
        .leaderboard-row.other { background:#f5f5f5;color:#2d3436; }
        .leaderboard-panel-close { position:absolute; top:15px; right:20px; background:linear-gradient(135deg,#ff7675,#d63031); color:white; border:none; border-radius:50%; width:38px; height:38px; font-size:20px; cursor:pointer; font-weight:bold; }
        .my-rank-info { text-align:center; margin-top:18px; font-size:16px; font-weight:bold; color:#6c5ce7; background:#f0eeff; padding:12px; border-radius:12px; }
        .lb-rank { font-size:24px; min-width:36px; text-align:center; }
        .lb-name { flex:1; font-size:17px; }
        .lb-xp { font-size:16px; }
        .lb-streak { font-size:14px; }

        /* ===== BG ===== */
        .bg-decoration { position: fixed; border-radius: 50%; opacity: .1; animation: float 20s infinite ease-in-out; pointer-events: none; }
        .circle1{width:300px;height:300px;background:white;top:-100px;left:-100px;animation-delay:0s;}
        .circle2{width:200px;height:200px;background:white;bottom:-50px;right:-50px;animation-delay:5s;}
        .circle3{width:150px;height:150px;background:white;top:50%;right:10%;animation-delay:10s;}
        @keyframes float{0%,100%{transform:translateY(0) rotate(0deg);}50%{transform:translateY(-30px) rotate(180deg);}}
        .star-bg{position:fixed;font-size:30px;opacity:.3;animation:twinkle 3s infinite;}
        @keyframes twinkle{0%,100%{opacity:.3;transform:scale(1);}50%{opacity:.8;transform:scale(1.2);}}

        /* ===== MAIN CONTAINER ===== */
        .container { background: white; border-radius: 30px; padding: 40px; max-width: 960px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,.3); position: relative; z-index: 10; margin-top: 70px; }

        /* ===== XP HEADER ===== */
        .xp-header { background: linear-gradient(135deg,#fff9e6,#ffe680); padding: 20px 30px; border-radius: 20px; margin-bottom: 20px; color: #2d3436; box-shadow: 0 10px 30px rgba(255,230,128,.4); position: relative; overflow: hidden; border: 3px solid #ffd700; }
        .xp-header::before { content:'‚ú®'; position:absolute; top:10px; right:20px; font-size:40px; opacity:.3; animation:twinkle 3s infinite; }
        .xp-info { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-wrap:wrap; gap:15px; }
        .student-name { font-size:28px; font-weight:900; background:linear-gradient(135deg,#f39c12,#e67e22); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; font-family:'Fredoka One',cursive; }
        .student-id { font-size:13px; font-weight:700; color:#b2800d; background:rgba(243,156,18,.12); border:1.5px solid #f39c12; border-radius:20px; padding:2px 12px; display:inline-block; margin-top:4px; letter-spacing:.5px; }
        .level-display { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
        .xp-amount { font-size:20px; font-weight:700; background:rgba(243,156,18,.2); color:#2d3436; padding:5px 15px; border-radius:20px; border:2px solid #f39c12; }
        .streak-badge { font-size:16px; font-weight:700; background:rgba(255,107,53,.2); color:#d63031; padding:5px 15px; border-radius:20px; border:2px solid #ff7675; }
        .badge-mini-count { font-size:16px; font-weight:700; background:rgba(255,215,0,.3); color:#2d3436; padding:5px 15px; border-radius:20px; border:2px solid #ffd700; cursor:pointer; }
        .badge-mini-count:hover { background:rgba(255,215,0,.5); }
        .mode-xp-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(130px,1fr)); gap:10px; margin-top:15px; }
        .mode-xp-card { background:rgba(255,255,255,.5); padding:10px; border-radius:10px; text-align:center; border:2px solid #ffd700; }
        .mode-xp-card.locked { opacity:.5; background:rgba(149,165,166,.3); border-color:#95a5a6; }
        .mode-xp-card.bonus-card { border-color:#e17055; background: rgba(255,120,80,.08); }
        .mode-xp-card.bonus-card .mode-xp-name { color: #e17055; }
        .mode-xp-name { font-size:13px; font-weight:800; color:#2d3436; margin-bottom:5px; }
        .mode-xp-value { font-size:17px; font-weight:900; color:#f39c12; }
        .mode-xp-progress { width:100%; height:8px; background:rgba(243,156,18,.2); border-radius:4px; overflow:hidden; margin-top:5px; }
        .mode-xp-progress-fill { height:100%; background:linear-gradient(90deg,#ffd700,#ffed4e); transition:width .8s ease; }

        /* ===== DAILY BANNER ===== */
        .daily-banner { background: linear-gradient(135deg, #00b894, #00cec9); color: white; border-radius: 16px; padding: 18px 24px; margin-bottom: 20px; display: flex; align-items: center; gap: 18px; box-shadow: 0 6px 20px rgba(0,184,148,.3); cursor: pointer; transition: all .3s; }
        .daily-banner:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(0,184,148,.4); }
        .daily-banner.completed { background: linear-gradient(135deg,#b2bec3,#95a5a6); cursor: default; }
        .daily-icon { font-size: 40px; }
        .daily-text { flex: 1; }
        .daily-title { font-size: 18px; font-weight: 900; margin-bottom: 4px; }
        .daily-desc { font-size: 14px; opacity: .9; }
        .daily-xp { font-size: 22px; font-weight: 900; background: rgba(255,255,255,.2); padding: 8px 18px; border-radius: 12px; }

        #nextUnlockInfo { background: linear-gradient(135deg,#ffeaa7,#fdcb6e); padding: 15px 20px; border-radius: 15px; text-align: center; margin-bottom: 20px; font-size: 16px; font-weight: bold; color: #2d3436; box-shadow: 0 5px 15px rgba(253,203,110,.3); animation: slideIn .5s ease-out; }

        .difficulty-xp-badge { display:inline-block; padding:4px 12px; border-radius:20px; font-size:13px; font-weight:900; margin-left:8px; }
        .diff-easy { background:#55efc4; color:#00b894; }
        .diff-medium { background:#fdcb6e; color:#e17055; }
        .diff-hard { background:#fd79a8; color:#e84393; }

        .xp-gain-popup { position:fixed; top:20%; right:20px; background:linear-gradient(135deg,#00b894,#00cec9); color:white; padding:15px 25px; border-radius:15px; font-size:20px; font-weight:900; box-shadow:0 10px 30px rgba(0,184,148,.5); z-index:9999; animation:slideInRight .5s ease-out, fadeOut .5s ease-out 2.5s; }
        @keyframes slideInRight { from{transform:translateX(100%);opacity:0;} to{transform:translateX(0);opacity:1;} }
        @keyframes fadeOut { from{opacity:1;} to{opacity:0;} }
        .unlock-notification { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:linear-gradient(135deg,#00b894,#00cec9); padding:40px 60px; border-radius:30px; font-size:32px; font-weight:900; color:white; box-shadow:0 20px 60px rgba(0,0,0,.5); z-index:10000; animation:unlockPop 2s ease-out; text-align:center; }
        @keyframes unlockPop { 0%{transform:translate(-50%,-50%) scale(0) rotate(-180deg);opacity:0;} 50%{transform:translate(-50%,-50%) scale(1.2) rotate(180deg);} 100%{transform:translate(-50%,-50%) scale(1) rotate(360deg);opacity:1;} }
        .unlock-notification.bonus { background: linear-gradient(135deg,#f39c12,#e17055); }
        .mode-btn.locked { opacity:.5; cursor:not-allowed!important; background:linear-gradient(135deg,#95a5a6,#7f8c8d)!important; color:#ecf0f1!important; position:relative; }
        .mode-btn.locked::after { content:''; position:absolute; top:0; left:0; right:0; bottom:0; background:repeating-linear-gradient(45deg,rgba(0,0,0,.1),rgba(0,0,0,.1) 10px,transparent 10px,transparent 20px); border-radius:15px; pointer-events:none; }
        .mode-btn.locked:hover { transform:none!important; box-shadow:none!important; }
        .mode-btn.bonus-mode { border-color: #e17055; background: linear-gradient(135deg,#fff5f0,#fff); color: #e17055; }
        .mode-btn.bonus-mode.active { background: linear-gradient(135deg,#e17055,#d63031); color: white; border-color: #d63031; }
        .mode-btn.bonus-mode:hover:not(.locked) { box-shadow: 0 10px 30px rgba(225,112,85,.3); }

        .mascot { position:absolute; top:-60px; right:30px; font-size:80px; animation:bounce 2s infinite; cursor:pointer; transition:transform .3s; }
        .mascot:hover { transform:scale(1.2) rotate(10deg); }
        @keyframes bounce { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-10px);} }
        h1 { background:linear-gradient(135deg,#667eea,#764ba2); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; text-align:center; margin-bottom:10px; font-size:40px; font-family:'Fredoka One',cursive; letter-spacing:1px; }
        .subtitle { text-align:center; color:#666; margin-bottom:30px; font-size:18px; font-weight:800; }

        /* ===== MODE SELECTOR ===== */
        .mode-selector { display:grid; grid-template-columns: repeat(4, 1fr); gap:10px; margin-bottom:10px; }
        .mode-selector-row2 { display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; margin-bottom:30px; }
        .mode-btn { padding:15px 8px; border:3px solid #667eea; background:white; color:#667eea; border-radius:15px; cursor:pointer; font-size:14px; font-weight:800; transition:all .3s; position:relative; overflow:hidden; text-align:center; font-family:'Nunito',sans-serif; }
        .mode-btn::before { content:''; position:absolute; top:50%; left:50%; width:0; height:0; border-radius:50%; background:rgba(102,126,234,.1); transform:translate(-50%,-50%); transition:width .6s,height .6s; }
        .mode-btn:hover::before { width:300px; height:300px; }
        .mode-btn.active { background:linear-gradient(135deg,#667eea,#764ba2); color:white; transform:scale(1.05); box-shadow:0 10px 25px rgba(102,126,234,.4); }
        .mode-btn:hover:not(.locked) { transform:translateY(-5px); box-shadow:0 10px 30px rgba(102,126,234,.3); }
        .mode-btn.active:hover { transform:scale(1.05); }
        .mode-row-label { font-size:12px; font-weight:900; text-align:center; color:#95a5a6; letter-spacing:2px; text-transform:uppercase; margin-bottom:8px; margin-top:4px; }

        .chat-area { background:linear-gradient(180deg,#f5f5f5,#e8e8e8); border-radius:20px; padding:25px; min-height:350px; max-height:450px; overflow-y:auto; margin-bottom:20px; border:3px solid #e0e0e0; position:relative; }
        .chat-area::before { content:'üí¨'; position:absolute; top:10px; right:15px; font-size:40px; opacity:.2; }
        .message { margin-bottom:15px; padding:15px 20px; border-radius:15px; animation:slideIn .4s ease-out; position:relative; max-width:80%; }
        .user-msg { background:linear-gradient(135deg,#667eea,#764ba2); color:white; margin-left:auto; text-align:right; box-shadow:0 5px 15px rgba(102,126,234,.3); }
        .user-msg::after { content:'üòä'; position:absolute; right:-35px; top:50%; transform:translateY(-50%); font-size:24px; }
        .ai-msg { background:white; color:#333; margin-right:auto; border:2px solid #e0e0e0; box-shadow:0 3px 10px rgba(0,0,0,.1); }
        .ai-msg::before { content:'ü§ñ'; position:absolute; left:-35px; top:50%; transform:translateY(-50%); font-size:24px; }

        /* ===== ROLEPLAY ROLE BADGE ===== */
        .roleplay-role-badge { display:inline-flex; align-items:center; gap:8px; padding:8px 16px; border-radius:20px; font-size:14px; font-weight:800; margin-bottom:12px; }
        .role-teacher    { background:#e8f5e9; color:#2e7d32; border:2px solid #a5d6a7; }
        .role-friend     { background:#e3f2fd; color:#1565c0; border:2px solid #90caf9; }
        .role-interviewer{ background:#fce4ec; color:#880e4f; border:2px solid #f48fb1; }
        .role-viva       { background:#f3e5f5; color:#4a148c; border:2px solid #ce93d8; }

        .roleplay-selector,.settings-panel { background:linear-gradient(135deg,#ffeaa7,#fdcb6e); padding:20px; border-radius:15px; margin-bottom:20px; border:3px solid #fdcb6e; box-shadow:0 5px 15px rgba(253,203,110,.3); }
        .setting-group { margin-bottom:15px; }
        .setting-group:last-child { margin-bottom:0; }
        .setting-group label,.roleplay-selector label { display:block; font-weight:800; margin-bottom:10px; color:#2d3436; font-size:17px; }
        .setting-group select,.roleplay-selector select { width:100%; padding:12px; border:3px solid #fdcb6e; border-radius:10px; font-size:16px; cursor:pointer; background:white; font-weight:bold; }
        .category-icon { display:inline-block; margin-right:8px; font-size:24px; animation:wiggle 2s infinite; }
        @keyframes wiggle { 0%,100%{transform:rotate(0);} 25%{transform:rotate(-5deg);} 75%{transform:rotate(5deg);} }
        .difficulty-hint { background:rgba(255,255,255,.6); border-radius:10px; padding:10px 15px; margin-top:12px; font-size:14px; font-weight:bold; color:#2d3436; text-align:center; }

        .progress-bar { background:#e0e0e0; height:40px; border-radius:20px; overflow:hidden; margin-bottom:25px; border:3px solid #d0d0d0; position:relative; }
        .progress-fill { background:linear-gradient(90deg,#00b894,#00cec9,#0984e3); height:100%; transition:width .8s ease; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold; font-size:18px; position:relative; overflow:hidden; }
        .progress-fill::before { content:''; position:absolute; top:0; left:-100%; width:100%; height:100%; background:linear-gradient(90deg,transparent,rgba(255,255,255,.3),transparent); animation:shimmer 2s infinite; }
        @keyframes shimmer { 0%{left:-100%;} 100%{left:100%;} }

        .stats { display:flex; justify-content:space-around; margin-bottom:25px; text-align:center; gap:15px; }
        .stat-item { flex:1; background:linear-gradient(135deg,#a29bfe,#6c5ce7); padding:20px; border-radius:15px; box-shadow:0 5px 15px rgba(108,92,231,.3); transition:transform .3s; }
        .stat-item:hover { transform:translateY(-5px) scale(1.05); }
        .stat-value { font-size:36px; font-weight:bold; color:white; text-shadow:2px 2px 4px rgba(0,0,0,.2); }
        .stat-label { font-size:14px; color:rgba(255,255,255,.9); margin-top:5px; font-weight:bold; }

        #repeatSentence,.spell-display-box,.puzzle-display-box { background:linear-gradient(135deg,#74b9ff,#a29bfe); padding:30px; border-radius:20px; margin-bottom:20px; border:4px dashed #6c5ce7; text-align:center; font-size:26px; color:white; font-weight:bold; min-height:120px; display:flex; align-items:center; justify-content:center; box-shadow:0 10px 30px rgba(108,92,231,.3); position:relative; overflow:hidden; flex-direction:column; gap:12px; }

        .score-bar-container { margin:12px 0; }
        .score-bar-label { font-size:15px; font-weight:bold; color:#2d3436; margin-bottom:6px; }
        .score-bar-track { background:#e0e0e0; height:22px; border-radius:11px; overflow:hidden; border:2px solid #ccc; }
        .score-bar-fill { height:100%; border-radius:11px; transition:width 1s cubic-bezier(.4,0,.2,1); display:flex; align-items:center; justify-content:flex-end; padding-right:8px; color:white; font-weight:900; font-size:13px; }
        .score-bar-fill.green { background:linear-gradient(90deg,#00b894,#55efc4); }
        .score-bar-fill.yellow { background:linear-gradient(90deg,#fdcb6e,#ffeaa7); color:#2d3436; }
        .score-bar-fill.red { background:linear-gradient(90deg,#d63031,#ff7675); }

        .word-highlight,.letter-highlight { display:inline-block; margin:0 5px; padding:5px 10px; border-radius:8px; font-size:20px; font-weight:bold; transition:all .3s; animation:popIn .3s ease-out; }
        @keyframes popIn { 0%{transform:scale(0);} 50%{transform:scale(1.2);} 100%{transform:scale(1);} }
        .word-correct,.letter-correct { background:#55efc4; color:#00b894; box-shadow:0 3px 10px rgba(0,184,148,.3); }
        .word-incorrect,.letter-incorrect { background:#ff7675; color:#d63031; text-decoration:line-through; box-shadow:0 3px 10px rgba(214,48,49,.3); }
        .word-missing,.letter-missing { background:#ffeaa7; color:#fdcb6e; box-shadow:0 3px 10px rgba(253,203,110,.3); }
        .hint-box { background:linear-gradient(135deg,#74b9ff,#a29bfe); color:white; padding:14px 20px; border-radius:14px; margin-top:12px; font-size:17px; font-weight:bold; animation:slideIn .4s ease-out; display:flex; align-items:center; gap:10px; }

        .controls { display:flex; gap:15px; align-items:center; flex-wrap:wrap; }
        .mic-btn { flex:1; min-width:150px; padding:18px; background:linear-gradient(135deg,#667eea,#764ba2); color:white; border:none; border-radius:15px; font-size:16px; cursor:pointer; font-weight:800; transition:all .3s; box-shadow:0 5px 15px rgba(102,126,234,.4); position:relative; overflow:hidden; font-family:'Nunito',sans-serif; }
        .mic-btn::before { content:''; position:absolute; top:50%; left:50%; width:0; height:0; border-radius:50%; background:rgba(255,255,255,.3); transform:translate(-50%,-50%); transition:width .6s,height .6s; }
        .mic-btn:hover::before { width:300px; height:300px; }
        .mic-btn:hover { transform:translateY(-3px); box-shadow:0 8px 25px rgba(102,126,234,.5); }
        .mic-btn.recording { background:linear-gradient(135deg,#ff7675,#d63031); animation:pulse 1.5s infinite; }
        @keyframes pulse { 0%,100%{transform:scale(1);box-shadow:0 5px 15px rgba(214,48,49,.4);} 50%{transform:scale(1.08);box-shadow:0 8px 25px rgba(214,48,49,.6);} }
        .mic-btn:disabled { background:#b2bec3; cursor:not-allowed; box-shadow:none; transform:none; }
        .secondary-btn { background:linear-gradient(135deg,#fdcb6e,#e17055); }
        .secondary-btn:hover { box-shadow:0 8px 25px rgba(253,203,110,.5); }
        .green-btn { background:linear-gradient(135deg,#00b894,#00cec9); }
        .green-btn:hover { box-shadow:0 8px 25px rgba(0,184,148,.5); }

        .feedback { background:linear-gradient(135deg,#ffeaa7,#fdcb6e); padding:20px; border-radius:15px; margin-top:20px; border-left:6px solid #f39c12; font-weight:bold; box-shadow:0 5px 15px rgba(243,156,18,.3); animation:slideIn .5s ease-out; }
        .stars { font-size:48px; text-align:center; margin:15px 0; }
        .star { display:inline-block; margin:0 5px; animation:starPop .5s ease-out; }
        @keyframes starPop { 0%{transform:scale(0) rotate(0);} 50%{transform:scale(1.3) rotate(180deg);} 100%{transform:scale(1) rotate(360deg);} }
        .star.filled { color:#ffd700; filter:drop-shadow(0 0 10px #ffd700); }
        .star.empty { color:#ddd; }

        .badges-row { display:flex; justify-content:center; gap:20px; margin:25px 0; }
        .badge { text-align:center; padding:15px; border-radius:15px; background:linear-gradient(135deg,#dfe6e9,#b2bec3); min-width:100px; transition:all .5s; border:3px solid #b2bec3; }
        .badge.unlocked { background:linear-gradient(135deg,#ffd700,#ffed4e); border:3px solid #f39c12; animation:badgeUnlock 1s ease-out; box-shadow:0 10px 30px rgba(255,215,0,.5); }
        @keyframes badgeUnlock { 0%{transform:scale(0) rotate(-180deg);} 50%{transform:scale(1.2) rotate(180deg);} 100%{transform:scale(1) rotate(360deg);} }
        .badge-icon { font-size:48px; filter:grayscale(100%); transition:filter .5s; }
        .badge.unlocked .badge-icon { filter:grayscale(0%); }
        .badge-name { font-size:14px; margin-top:8px; font-weight:bold; color:#2d3436; }

        .hidden { display:none; }
        .sound-wave { display:none; justify-content:center; align-items:center; gap:6px; margin:20px 0; }
        .sound-wave.active { display:flex; }
        .wave-bar { width:6px; height:30px; background:linear-gradient(180deg,#667eea,#764ba2); border-radius:3px; animation:wave 1s ease-in-out infinite; box-shadow:0 3px 10px rgba(102,126,234,.5); }
        .wave-bar:nth-child(1){animation-delay:0s} .wave-bar:nth-child(2){animation-delay:.1s} .wave-bar:nth-child(3){animation-delay:.2s} .wave-bar:nth-child(4){animation-delay:.3s} .wave-bar:nth-child(5){animation-delay:.4s}
        @keyframes wave { 0%,100%{height:30px;} 50%{height:60px;} }
        @keyframes slideIn { from{transform:translateY(-20px);opacity:0;} to{transform:translateY(0);opacity:1;} }

        /* ===== SPELL BEE ===== */
        .spell-input-container { background:white; padding:25px; border-radius:15px; margin-bottom:20px; border:3px solid #e0e0e0; box-shadow:0 5px 15px rgba(0,0,0,.1); }
        .spell-input-box { display:flex; gap:15px; align-items:center; }
        .spell-input { flex:1; padding:18px; border:3px solid #6c5ce7; border-radius:15px; font-size:24px; font-weight:bold; text-align:center; letter-spacing:5px; outline:none; transition:all .3s; text-transform:uppercase; font-family:'Nunito',sans-serif; }
        .spell-input:focus { border-color:#667eea; box-shadow:0 0 0 3px rgba(102,126,234,.3); transform:scale(1.02); }

        /* ===== WORD MEANINGS ===== */
        .word-input-container { background:linear-gradient(135deg,#74b9ff,#a29bfe); padding:30px; border-radius:20px; margin-bottom:20px; border:4px solid #6c5ce7; box-shadow:0 10px 30px rgba(108,92,231,.3); }
        .word-input-box { display:flex; gap:15px; align-items:center; }
        .word-input { flex:1; padding:18px; border:3px solid white; border-radius:15px; font-size:20px; font-weight:bold; outline:none; transition:all .3s; font-family:'Nunito',sans-serif; }
        .word-input:focus { border-color:#ffd700; box-shadow:0 0 0 3px rgba(255,215,0,.3); transform:scale(1.02); }
        .word-meaning-display { background:white; padding:30px; border-radius:20px; margin-bottom:20px; border:3px solid #e0e0e0; box-shadow:0 5px 15px rgba(0,0,0,.1); min-height:200px; }
        .meaning-section { margin-bottom:20px; padding-bottom:20px; border-bottom:2px solid #f0f0f0; }
        .meaning-section:last-child { border-bottom:none; }
        .meaning-label { font-size:18px; font-weight:bold; color:#667eea; margin-bottom:10px; display:flex; align-items:center; gap:10px; }
        .meaning-text { font-size:18px; color:#2d3436; line-height:1.6; }
        .bonus-unlocked-banner { background: linear-gradient(135deg,#ffeaa7,#fdcb6e); border: 3px solid #e17055; border-radius: 14px; padding: 14px 20px; margin-bottom: 20px; text-align: center; font-size: 16px; font-weight: 900; color: #e17055; }

        /* ===== WORD PUZZLE ===== */
        .puzzle-scrambled { font-size:48px; font-weight:900; letter-spacing:10px; color:white; text-shadow:0 4px 12px rgba(0,0,0,.25); font-family:'Fredoka One',cursive; }
        .puzzle-meta { display:flex; gap:12px; flex-wrap:wrap; justify-content:center; }
        .puzzle-tag { background:rgba(255,255,255,.25); color:white; padding:5px 14px; border-radius:20px; font-size:14px; font-weight:800; }
        .puzzle-hint-box { background:linear-gradient(135deg,#ffeaa7,#fdcb6e); border:3px solid #f39c12; border-radius:16px; padding:16px 22px; margin-bottom:18px; text-align:center; }
        .puzzle-hint-label { font-size:11px; font-weight:900; text-transform:uppercase; letter-spacing:1.5px; color:#e17055; margin-bottom:6px; }
        .puzzle-hint-text { font-size:18px; font-weight:800; color:#2d3436; }
        .puzzle-input-container { background:white; padding:25px; border-radius:15px; margin-bottom:20px; border:3px solid #e0e0e0; box-shadow:0 5px 15px rgba(0,0,0,.1); }
        .puzzle-input { width:100%; padding:18px; border:3px solid #6c5ce7; border-radius:15px; font-size:26px; font-weight:900; text-align:center; letter-spacing:6px; outline:none; transition:all .3s; text-transform:uppercase; font-family:'Fredoka One',cursive; }
        .puzzle-input:focus { border-color:#667eea; box-shadow:0 0 0 3px rgba(102,126,234,.3); transform:scale(1.02); }

        /* ===== GRAMMAR MCQ ===== */
        .grammar-question-box { background:linear-gradient(135deg,#a29bfe,#6c5ce7); padding:28px 30px; border-radius:20px; margin-bottom:20px; text-align:center; box-shadow:0 10px 30px rgba(108,92,231,.3); }
        .grammar-question-text { font-size:22px; font-weight:900; color:white; line-height:1.5; }
        .grammar-blank { background:rgba(255,255,255,.3); color:#ffd700; padding:2px 14px; border-radius:8px; font-size:26px; font-weight:900; margin:0 4px; display:inline-block; min-width:80px; letter-spacing:2px; vertical-align:middle; }
        .grammar-options-grid { display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-bottom:20px; }
        .grammar-option-btn { padding:18px 20px; border:3px solid #e0e0e0; background:white; border-radius:14px; font-size:18px; font-weight:800; cursor:pointer; transition:all .3s; text-align:center; color:#2d3436; font-family:'Nunito',sans-serif; }
        .grammar-option-btn:hover:not(:disabled) { border-color:#667eea; background:#f0eeff; transform:translateY(-3px); box-shadow:0 8px 20px rgba(102,126,234,.25); }
        .grammar-option-btn.correct { background:linear-gradient(135deg,#55efc4,#00b894); border-color:#00b894; color:white; transform:scale(1.04); box-shadow:0 8px 20px rgba(0,184,148,.4); }
        .grammar-option-btn.wrong   { background:linear-gradient(135deg,#ff7675,#d63031); border-color:#d63031; color:white; }
        .grammar-option-btn:disabled { cursor:not-allowed; }
        .grammar-explanation { background:linear-gradient(135deg,#ffeaa7,#fdcb6e); border:3px solid #f39c12; border-radius:16px; padding:18px 22px; margin-bottom:18px; font-size:16px; font-weight:bold; color:#2d3436; animation:slideIn .4s ease-out; }
        .grammar-explanation-label { font-size:12px; font-weight:900; text-transform:uppercase; letter-spacing:1px; color:#e17055; margin-bottom:6px; }
        .grammar-score-row { display:flex; gap:14px; justify-content:center; flex-wrap:wrap; margin-bottom:20px; }
        .grammar-score-card { background:linear-gradient(135deg,#a29bfe,#6c5ce7); color:white; padding:16px 24px; border-radius:14px; text-align:center; min-width:110px; box-shadow:0 5px 15px rgba(108,92,231,.3); }
        .grammar-score-val { font-size:30px; font-weight:900; }
        .grammar-score-lbl { font-size:13px; opacity:.9; font-weight:700; margin-top:2px; }

        /* ===== COMPLETION MODAL ===== */
        .completion-modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.8); display:none; justify-content:center; align-items:center; z-index:1000; backdrop-filter:blur(5px); }
        .completion-modal.active { display:flex; animation:fadeIn .5s ease-out; }
        @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
        .modal-content { background:white; padding:50px; border-radius:30px; text-align:center; max-width:500px; animation:modalPop .5s ease-out; box-shadow:0 20px 60px rgba(0,0,0,.5); position:relative; overflow:hidden; }
        @keyframes modalPop { 0%{transform:scale(0) rotate(-180deg);} 50%{transform:scale(1.1) rotate(10deg);} 100%{transform:scale(1) rotate(0);} }
        .modal-content h2 { background:linear-gradient(135deg,#667eea,#764ba2); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; margin-bottom:25px; font-size:42px; font-family:'Fredoka One',cursive; }
        .final-score { font-size:64px; background:linear-gradient(135deg,#ffd700,#ffed4e); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; font-weight:bold; margin:25px 0; }
        .modal-message { font-size:24px; color:#2d3436; margin:20px 0; font-weight:bold; }

        .confetti { position:fixed; width:10px; height:10px; background:#f39c12; animation:confetti-fall 3s linear forwards; }
        @keyframes confetti-fall { to{transform:translateY(100vh) rotate(360deg);opacity:0;} }

        @media(max-width:768px){
            .container{padding:20px;} h1{font-size:28px;} .mascot{font-size:55px;top:-45px;}
            .stats,.badges-row{flex-direction:column;} .mode-selector{grid-template-columns:repeat(2,1fr);}
            .mode-selector-row2{grid-template-columns:repeat(2,1fr);}
            .exit-btn{top:10px;left:10px;padding:10px 16px;font-size:13px;}
            .badges-toggle-btn{top:10px;right:10px;padding:10px 14px;font-size:12px;}
            .leaderboard-btn{top:58px;right:10px;padding:8px 12px;font-size:11px;}
            .xp-info{flex-direction:column;align-items:flex-start;gap:10px;}
            .student-name{font-size:20px;} .mode-xp-grid{grid-template-columns:repeat(2,1fr);}
            .badge-grid{grid-template-columns:repeat(2,1fr);}
            .grammar-options-grid{grid-template-columns:1fr;}
            .daily-modal-body{padding:18px 16px 22px;}
            .puzzle-scrambled{font-size:32px;letter-spacing:6px;}
        }
        @media(max-width:480px){ .badge-grid{grid-template-columns:repeat(2,1fr);} .mode-xp-grid{grid-template-columns:1fr;} .mode-selector{grid-template-columns:1fr 1fr;} .mode-selector-row2{grid-template-columns:1fr;} }
    </style>
</head>
<body>
    <button class="exit-btn" onclick="exitToHome()">üè† Exit</button>
    <button class="badges-toggle-btn" onclick="openBadgesPanel()">üèÖ Badges <span class="badge-count-bubble" id="badgeCountBubble">0</span></button>
    <button class="leaderboard-btn" onclick="openLeaderboard()">üèÜ Leaderboard</button>
    <div class="bg-decoration circle1"></div><div class="bg-decoration circle2"></div><div class="bg-decoration circle3"></div>
    <div class="star-bg" style="top:10%;left:10%">‚≠ê</div><div class="star-bg" style="top:20%;right:15%">‚ú®</div>
    <div class="star-bg" style="bottom:15%;left:20%">üåü</div><div class="star-bg" style="top:60%;right:25%">üí´</div>
    <div class="badge-toast-container" id="badgeToastContainer"></div>

    <!-- DAILY CHALLENGE MODAL -->
    <div class="daily-modal-overlay" id="dailyModalOverlay">
        <div class="daily-modal">
            <div class="daily-modal-header">
                <button class="daily-modal-close" onclick="closeDailyModal()">√ó</button>
                <div class="daily-modal-title">üåü Daily Challenge</div>
                <div class="daily-modal-subtitle">Complete both tasks to earn your +3 XP!</div>
            </div>
            <div class="daily-modal-body">
                <div class="daily-steps">
                    <div class="daily-step active" id="dStep1">1Ô∏è‚É£ Say the Word</div>
                    <div class="daily-step" id="dStep2">2Ô∏è‚É£ Say the Sentence</div>
                    <div class="daily-step" id="dStep3">üéÅ Claim XP</div>
                </div>
                <div id="dailyStep1">
                    <div class="challenge-card">
                        <div class="challenge-card-label">üìÖ Today's Word</div>
                        <div class="challenge-card-content word-display" id="dailyChallengeWord">‚Äî</div>
                        <button class="listen-btn" onclick="playDailyWordAudio()">üîä Listen to Word</button>
                    </div>
                    <p style="text-align:center;color:#636e72;font-size:14px;margin-bottom:8px;">Press the button and <strong>say the word out loud!</strong></p>
                    <div class="daily-sound-wave" id="dailySoundWave1"><div class="daily-wave-bar"></div><div class="daily-wave-bar"></div><div class="daily-wave-bar"></div><div class="daily-wave-bar"></div><div class="daily-wave-bar"></div></div>
                    <button class="daily-record-btn" id="dailyWordRecordBtn" onclick="recordDailyWord()">üé§ Say the Word</button>
                    <div class="daily-result" id="dailyWordResult"></div>
                    <button class="daily-next-btn" id="dailyWordNextBtn" onclick="goToDailyStep2()">‚úÖ Next: Say the Sentence ‚Üí</button>
                </div>
                <div id="dailyStep2" style="display:none;">
                    <div class="challenge-card">
                        <div class="challenge-card-label">üí¨ Today's Sentence</div>
                        <div class="challenge-card-content" id="dailyChallengeSentence">‚Äî</div>
                        <button class="listen-btn" onclick="playDailySentenceAudio()">üîä Listen to Sentence</button>
                    </div>
                    <p style="text-align:center;color:#636e72;font-size:14px;margin-bottom:8px;">Press the button and <strong>read the sentence aloud!</strong></p>
                    <div class="daily-sound-wave" id="dailySoundWave2"><div class="daily-wave-bar"></div><div class="daily-wave-bar"></div><div class="daily-wave-bar"></div><div class="daily-wave-bar"></div><div class="daily-wave-bar"></div></div>
                    <button class="daily-record-btn" id="dailySentRecordBtn" onclick="recordDailySentence()">üé§ Read the Sentence</button>
                    <div class="daily-result" id="dailySentResult"></div>
                    <button class="daily-next-btn" id="dailySentNextBtn" onclick="goToDailyStep3()">üéÅ Claim Your XP ‚Üí</button>
                </div>
                <div id="dailyStep3" style="display:none;">
                    <div class="daily-reward-box">
                        <div style="font-size:58px;margin-bottom:10px;">üéâ</div>
                        <div class="daily-reward-xp">+3 XP</div>
                        <div class="daily-reward-label">Challenge Complete! Amazing work!</div>
                        <div style="font-size:13px;color:#636e72;margin-top:6px;">Word ‚úÖ &nbsp; Sentence ‚úÖ</div>
                    </div>
                    <button class="daily-claim-btn" id="dailyClaimBtn" onclick="claimDailyXP()">üèÜ Claim +3 XP!</button>
                </div>
            </div>
        </div>
    </div>

    <!-- BADGES PANEL -->
    <div class="badges-panel-overlay" id="badgesPanelOverlay" onclick="closeBadgesPanelOutside(event)">
        <div class="badges-panel" id="badgesPanel">
            <button class="badges-panel-close" onclick="closeBadgesPanel()">√ó</button>
            <h2>üèÖ My Badge Collection</h2>
            <p class="badges-panel-subtitle" id="badgePanelSubtitle">Loading...</p>
            <div class="badge-progress-bar-wrap"><div class="badge-progress-bar-fill" id="badgeProgressBarFill" style="width:0%"></div></div>
            <div id="badgePanelContent">Loading badges...</div>
        </div>
    </div>

    <!-- LEADERBOARD PANEL -->
    <div class="leaderboard-overlay" id="leaderboardOverlay" onclick="closeLeaderboardOutside(event)">
        <div class="leaderboard-panel">
            <button class="leaderboard-panel-close" onclick="closeLeaderboard()">√ó</button>
            <h2>üèÜ Top Students</h2>
            <div id="leaderboardContent">Loading...</div>
            <div class="my-rank-info" id="myRankInfo"></div>
        </div>
    </div>

    <!-- MAIN CONTAINER -->
    <div class="container">
        <!-- XP HEADER -->
        <div class="xp-header">
            <div class="xp-info">
                <div>
                    <div class="student-name" id="studentName">üë§ Loading...</div>
                    <div class="student-id" id="studentId" style="display:none;">ID: ‚Äî</div>
                </div>
                <div class="level-display">
                    <span class="xp-amount" id="xpAmount">0 XP Total</span>
                    <span class="streak-badge" id="streakBadge">üî• 0 day streak</span>
                    <span class="badge-mini-count" id="badgeMiniCount" onclick="openBadgesPanel()">üèÖ 0 badges</span>
                </div>
            </div>
            <div class="mode-xp-grid">
                <div class="mode-xp-card" data-mode="conversation"><div class="mode-xp-name">üí¨ Conversation</div><div class="mode-xp-value" id="conversationXp">0/50</div><div class="mode-xp-progress"><div class="mode-xp-progress-fill" id="conversationProgress" style="width:0%"></div></div></div>
                <div class="mode-xp-card locked" data-mode="roleplay"><div class="mode-xp-name">üé≠ Roleplay</div><div class="mode-xp-value" id="roleplayXp">üîí</div><div class="mode-xp-progress"><div class="mode-xp-progress-fill" id="roleplayProgress" style="width:0%"></div></div></div>
                <div class="mode-xp-card locked" data-mode="repeat"><div class="mode-xp-name">üîÅ Repeat</div><div class="mode-xp-value" id="repeatXp">üîí</div><div class="mode-xp-progress"><div class="mode-xp-progress-fill" id="repeatProgress" style="width:0%"></div></div></div>
                <div class="mode-xp-card locked" data-mode="spellbee"><div class="mode-xp-name">üêù Spell Bee</div><div class="mode-xp-value" id="spellbeeXp">üîí</div><div class="mode-xp-progress"><div class="mode-xp-progress-fill" id="spellbeeProgress" style="width:0%"></div></div></div>
                <div class="mode-xp-card locked" data-mode="wordpuzzle"><div class="mode-xp-name">üß© Puzzle</div><div class="mode-xp-value" id="wordpuzzleXp">üîí</div><div class="mode-xp-progress"><div class="mode-xp-progress-fill" id="wordpuzzleProgress" style="width:0%"></div></div></div>
                <div class="mode-xp-card locked" data-mode="grammar"><div class="mode-xp-name">üìù Grammar</div><div class="mode-xp-value" id="grammarXp">üîí</div><div class="mode-xp-progress"><div class="mode-xp-progress-fill" id="grammarProgress" style="width:0%"></div></div></div>
                <div class="mode-xp-card locked bonus-card" data-mode="meanings"><div class="mode-xp-name">üìñ Meanings üéÅ</div><div class="mode-xp-value" id="meaningsXp">üîí</div><div class="mode-xp-progress"><div class="mode-xp-progress-fill" id="meaningsProgress" style="width:0%"></div></div></div>
            </div>
        </div>

        <div id="dailyBanner" class="daily-banner" style="display:none;">
            <span class="daily-icon">üåü</span>
            <div class="daily-text"><div class="daily-title" id="dailyTitle">Today's Challenge</div><div class="daily-desc" id="dailyDesc">Loading...</div></div>
            <span class="daily-xp">+3 XP</span>
        </div>
        <div id="nextUnlockInfo" style="display:none;"></div>

        <div class="mascot" title="Hi! I'm your English coach!">ü¶â</div>
        <h1>üé§ Gayathri Speak Smart</h1>
        <p class="subtitle">‚ú® Learn English in a fun way! ‚ú®</p>

        <!-- MODE BUTTONS ‚Äî Row 1 -->
        <div class="mode-selector">
            <button class="mode-btn active" data-mode="conversation" onclick="switchMode('conversation',event)">üí¨ Conversation</button>
            <button class="mode-btn" data-mode="roleplay" onclick="switchMode('roleplay',event)">üé≠ Roleplay</button>
            <button class="mode-btn" data-mode="repeat" onclick="switchMode('repeat',event)">üîÅ Repeat</button>
            <button class="mode-btn" data-mode="spellbee" onclick="switchMode('spellbee',event)">üêù Spell Bee</button>
        </div>
        <!-- MODE BUTTONS ‚Äî Row 2 -->
        <div class="mode-selector-row2">
            <button class="mode-btn" data-mode="wordpuzzle" onclick="switchMode('wordpuzzle',event)">üß© Word Puzzle</button>
            <button class="mode-btn" data-mode="grammar" onclick="switchMode('grammar',event)">üìù Grammar</button>
            <button class="mode-btn bonus-mode" data-mode="meanings" onclick="switchMode('meanings',event)">üìñ Meanings üéÅ</button>
        </div>

        <!-- =================== CONVERSATION =================== -->
        <div id="conversationMode">
            <div class="chat-area" id="chatArea"><div class="message ai-msg">Hello! I'm your English coach. Say something in English, and I'll help you improve! üòä</div></div>
            <div class="sound-wave" id="soundWave1"><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div></div>
            <div class="controls"><button class="mic-btn" id="micBtn" onclick="startRecording()">üé§ Click to Speak</button></div>
        </div>

        <!-- =================== ROLEPLAY =================== -->
        <!-- NOTE: "Normal Coach" option removed ‚Äî roleplay now requires choosing a role -->
        <div id="roleplayMode" class="hidden">
            <div class="roleplay-selector">
                <label><span class="category-icon">üé≠</span>Choose Your Roleplay Character:</label>
                <!-- CHANGED: removed the blank "Normal Coach" option; teacher is now the default -->
                <select id="roleplaySelect" onchange="handleRoleplayChange()">
                    <option value="teacher">üë©‚Äçüè´ Teacher</option>
                    <option value="friend">üë´ Friend</option>
                    <option value="interviewer">üíº Job Interviewer</option>
                    <option value="viva">üìö Viva Examiner</option>
                </select>
            </div>
            <!-- Role badge shown under the selector -->
            <div id="roleplayRoleBadge" style="margin-bottom:16px;"></div>
            <div class="chat-area" id="roleplayChatArea"><div class="message ai-msg">üë©‚Äçüè´ Teacher mode is ready! I'm your teacher ‚Äî ready to learn? Let's begin! üìö</div></div>
            <div class="sound-wave" id="soundWave3"><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div></div>
            <div class="controls"><button class="mic-btn" id="roleplayMicBtn" onclick="startRoleplayRecording()">üé§ Click to Speak</button></div>
        </div>

        <!-- =================== REPEAT =================== -->
        <div id="repeatMode" class="hidden">
            <div class="settings-panel">
                <div class="setting-group"><label><span class="category-icon">üìö</span>Choose Category:</label><select id="categorySelect"><option value="civic_sense">üèõÔ∏è Civic Sense</option><option value="animals">üê∂ Animals</option><option value="food">üçï Food</option><option value="sports">‚öΩ Sports</option><option value="feelings">üòä Feelings</option><option value="colors">üé® Colors</option><option value="family">üë®‚Äçüë©‚Äçüëß Family</option><option value="school">üè´ School</option></select></div>
                <div class="setting-group"><label><span class="category-icon">üéØ</span>Choose Difficulty:</label><select id="difficultySelect" onchange="updateRepeatXpHint()"><option value="easy">‚≠ê Easy (3-5 words)</option><option value="medium">‚≠ê‚≠ê Medium (6-8 words)</option><option value="hard">‚≠ê‚≠ê‚≠ê Hard (9-12 words)</option></select></div>
                <div class="difficulty-hint" id="repeatDiffHint">üí° Easy: <span class="difficulty-xp-badge diff-easy">+1 XP per stage</span></div>
            </div>
            <div class="progress-bar"><div class="progress-fill" id="progressFill">0/5 üöÄ</div></div>
            <div class="stats"><div class="stat-item"><div class="stat-value" id="currentScore">0</div><div class="stat-label">üìä Score</div></div><div class="stat-item"><div class="stat-value" id="totalScore">0</div><div class="stat-label">‚≠ê Stars</div></div><div class="stat-item"><div class="stat-value" id="accuracy">0%</div><div class="stat-label">üéØ Accuracy</div></div></div>
            <div class="badges-row"><div class="badge" id="badge1"><div class="badge-icon">ü•â</div><div class="badge-name">Beginner</div></div><div class="badge" id="badge2"><div class="badge-icon">ü•à</div><div class="badge-name">Pro</div></div><div class="badge" id="badge3"><div class="badge-icon">ü•á</div><div class="badge-name">Master</div></div></div>
            <div id="repeatSentence">Click "Start Stage" to begin! üöÄ</div>
            <div class="sound-wave" id="soundWave2"><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div></div>
            <div class="controls"><button class="mic-btn" onclick="startStage()" id="startBtn">üöÄ Start Stage</button><button class="mic-btn secondary-btn" onclick="playSlow()" id="slowBtn" style="display:none;">üê¢ Play Slow</button><button class="mic-btn" id="repeatMicBtn" onclick="recordRepeat()" style="display:none;">üé§ Repeat</button></div>
            <div id="repeatFeedback"></div>
        </div>

        <!-- =================== SPELL BEE =================== -->
        <div id="spellbeeMode" class="hidden">
            <div class="settings-panel">
                <div class="setting-group"><label><span class="category-icon">üéØ</span>Choose Difficulty:</label><select id="spellDifficultySelect" onchange="updateSpellXpHint()"><option value="easy">‚≠ê Easy (3-5 letters)</option><option value="medium">‚≠ê‚≠ê Medium (6-8 letters)</option><option value="hard">‚≠ê‚≠ê‚≠ê Hard (9-12 letters)</option></select></div>
                <div class="difficulty-hint" id="spellDiffHint">üí° Easy: <span class="difficulty-xp-badge diff-easy">+1 XP per stage</span></div>
            </div>
            <div class="progress-bar"><div class="progress-fill" id="spellProgressFill">0/5 üêù</div></div>
            <div class="stats"><div class="stat-item"><div class="stat-value" id="spellCurrentScore">0</div><div class="stat-label">üìä Score</div></div><div class="stat-item"><div class="stat-value" id="spellTotalScore">0</div><div class="stat-label">‚≠ê Stars</div></div><div class="stat-item"><div class="stat-value" id="spellAccuracy">0%</div><div class="stat-label">üéØ Accuracy</div></div></div>
            <div class="badges-row"><div class="badge" id="spellBadge1"><div class="badge-icon">ü•â</div><div class="badge-name">Spelling Star</div></div><div class="badge" id="spellBadge2"><div class="badge-icon">ü•à</div><div class="badge-name">Word Wizard</div></div><div class="badge" id="spellBadge3"><div class="badge-icon">ü•á</div><div class="badge-name">Champion</div></div></div>
            <div class="spell-display-box" id="spellWord">Click "Start Spelling" to begin! üêù</div>
            <div class="spell-input-container" id="spellInputContainer" style="display:none;"><div class="spell-input-box"><input type="text" class="spell-input" id="spellingInput" placeholder="TYPE HERE" maxlength="30"></div></div>
            <div class="sound-wave" id="soundWave4"><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div></div>
            <div class="controls"><button class="mic-btn" onclick="startSpelling()" id="spellStartBtn">üöÄ Start Spelling</button><button class="mic-btn secondary-btn" onclick="playWordAgain()" id="playWordBtn" style="display:none;">üîä Word Again</button><button class="mic-btn secondary-btn" onclick="playUsageAgain()" id="playUsageBtn" style="display:none;">üìù Usage</button><button class="mic-btn green-btn" onclick="checkSpelling()" id="checkSpellBtn" style="display:none;">‚úì Check</button></div>
            <div id="spellFeedback"></div>
        </div>

        <!-- =================== WORD PUZZLE =================== -->
        <div id="wordpuzzleMode" class="hidden">
            <div class="settings-panel">
                <div class="setting-group"><label><span class="category-icon">üß©</span>Choose Difficulty:</label><select id="puzzleDifficultySelect" onchange="updatePuzzleXpHint()"><option value="easy">‚≠ê Easy (3 letters)</option><option value="medium">‚≠ê‚≠ê Medium (5-6 letters)</option><option value="hard">‚≠ê‚≠ê‚≠ê Hard (8-12 letters)</option></select></div>
                <div class="difficulty-hint" id="puzzleDiffHint">üí° Easy: <span class="difficulty-xp-badge diff-easy">+1 XP per puzzle</span></div>
            </div>
            <div class="progress-bar"><div class="progress-fill" id="puzzleProgressFill">0/5 üß©</div></div>
            <div class="grammar-score-row" style="margin-bottom:20px;">
                <div class="grammar-score-card"><div class="grammar-score-val" id="puzzleSolved">0</div><div class="grammar-score-lbl">‚úÖ Solved</div></div>
                <div class="grammar-score-card"><div class="grammar-score-val" id="puzzleStars">0</div><div class="grammar-score-lbl">‚≠ê Stars</div></div>
                <div class="grammar-score-card"><div class="grammar-score-val" id="puzzleAccuracy">0%</div><div class="grammar-score-lbl">üéØ Accuracy</div></div>
            </div>
            <div class="puzzle-display-box" id="puzzleDisplayBox"><div>Click "Start Puzzle" to play! üß©</div></div>
            <div class="puzzle-hint-box" id="puzzleHintBox" style="display:none;"><div class="puzzle-hint-label">üí° Hint</div><div class="puzzle-hint-text" id="puzzleHintText">‚Äî</div></div>
            <div class="puzzle-input-container" id="puzzleInputContainer" style="display:none;"><input type="text" class="puzzle-input" id="puzzleInput" placeholder="TYPE YOUR ANSWER" maxlength="25"></div>
            <div class="controls">
                <button class="mic-btn" id="puzzleStartBtn" onclick="startPuzzle()">üöÄ Start Puzzle</button>
                <button class="mic-btn secondary-btn" id="puzzleHintAudioBtn" onclick="playPuzzleHintAudio()" style="display:none;">üîä Hear Hint</button>
                <button class="mic-btn green-btn" id="puzzleCheckBtn" onclick="checkPuzzle()" style="display:none;">‚úÖ Check Answer</button>
            </div>
            <div id="puzzleFeedback"></div>
        </div>

        <!-- =================== GRAMMAR =================== -->
        <div id="grammarMode" class="hidden">
            <div class="settings-panel">
                <div class="setting-group"><label><span class="category-icon">üìù</span>Choose Difficulty:</label><select id="grammarDifficultySelect" onchange="updateGrammarXpHint()"><option value="easy">‚≠ê Easy</option><option value="medium">‚≠ê‚≠ê Medium</option><option value="hard">‚≠ê‚≠ê‚≠ê Hard</option></select></div>
                <div class="difficulty-hint" id="grammarDiffHint">üí° Easy: <span class="difficulty-xp-badge diff-easy">+1 XP per question</span></div>
            </div>
            <div class="progress-bar"><div class="progress-fill" id="grammarProgressFill">0/5 üìù</div></div>
            <div class="grammar-score-row">
                <div class="grammar-score-card"><div class="grammar-score-val" id="grammarCorrect">0</div><div class="grammar-score-lbl">‚úÖ Correct</div></div>
                <div class="grammar-score-card"><div class="grammar-score-val" id="grammarTotal">0</div><div class="grammar-score-lbl">üìã Total</div></div>
                <div class="grammar-score-card"><div class="grammar-score-val" id="grammarStars">0</div><div class="grammar-score-lbl">‚≠ê Stars</div></div>
            </div>
            <div class="grammar-question-box" id="grammarQuestionBox">
                <div class="grammar-question-text" id="grammarQuestionText" style="color:rgba(255,255,255,.7);font-size:18px;">Click "Start Quiz" to begin! üìù</div>
            </div>
            <div class="grammar-options-grid" id="grammarOptionsGrid" style="display:none;"></div>
            <div class="grammar-explanation" id="grammarExplanation" style="display:none;"><div class="grammar-explanation-label">üìö Why?</div><div id="grammarExplanationText"></div></div>
            <div class="sound-wave" id="soundWave7"><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div></div>
            <div class="controls" id="grammarControls">
                <button class="mic-btn" id="grammarStartBtn" onclick="startGrammarQuiz()">üöÄ Start Quiz</button>
                <button class="mic-btn secondary-btn" id="grammarAudioBtn" onclick="playGrammarAudio()" style="display:none;">üîä Hear Question</button>
                <button class="mic-btn green-btn" id="grammarNextBtn" onclick="nextGrammarQuestion()" style="display:none;">‚û°Ô∏è Next Question</button>
            </div>
        </div>

        <!-- =================== WORD MEANINGS (BONUS) =================== -->
        <div id="meaningsMode" class="hidden">
            <div class="bonus-unlocked-banner">üéÅ <strong>Bonus Mode Unlocked!</strong> You've mastered all the core modes. Explore word meanings as your reward! üèÜ</div>
            <div class="word-input-container"><h3 style="color:white;text-align:center;margin-bottom:20px;font-size:24px;font-weight:900;"><span class="category-icon">üìñ</span>Ask me about any word!</h3><div class="word-input-box"><input type="text" class="word-input" id="wordInput" placeholder="Type a word here..." onkeypress="if(event.key==='Enter') getMeaning()"><button class="mic-btn" onclick="getMeaning()" style="min-width:140px;flex:unset;">üîç Get Meaning</button></div></div>
            <div class="word-meaning-display" id="wordMeaningDisplay"><div style="text-align:center;color:#999;font-size:20px;padding:60px 20px;"><span style="font-size:80px;display:block;margin-bottom:20px;">üìö</span>Type any word above and I'll explain it to you in a simple way!</div></div>
            <div class="sound-wave" id="soundWave5"><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div></div>
        </div>
    </div><!-- /container -->

    <!-- COMPLETION MODAL -->
    <div class="completion-modal" id="completionModal">
        <div class="modal-content"><h2>üéâ Stage Complete!</h2><div class="stars" id="modalStars"></div><div class="final-score" id="modalScore">0/15</div><p class="modal-message" id="modalMessage"></p><button class="mic-btn" onclick="closeModal()">üéÆ Play Again</button></div>
    </div>

<script>
// ============================================================
//  STATE
// ============================================================
let currentMode='conversation', recognition, currentSentence='', currentAudioSlow='';
let autoReactivate=true, currentAudioPlaying=null;
let currentStage=0, totalStages=5, stageScores=[], totalStars=0, currentRepeatDifficulty='easy';
let currentSpellStage=0, spellStageScores=[], spellTotalStars=0;
let currentWord='', currentWordAudio='', currentUsageAudio='', currentSpellDifficulty='easy', spellAttemptCount=0;
let studentXP=0, studentName='Student', studentId='';
let modeXP={conversation:0,roleplay:0,repeat:0,spellbee:0,meanings:0,wordpuzzle:0,grammar:0};
let unlockedFeatures=['conversation'], allBadgesData=[], earnedBadgeCount=0, totalBadgeCount=0, currentStreak=0;
const XP_PER_UNLOCK=50, DIFFICULTY_XP={easy:1,medium:2,hard:5};

// Daily challenge
let dailyChallengeData=null, dailyWordDone=false, dailySentDone=false, dailyXPClaimed=false;

// Word Puzzle state
let currentPuzzleStage=0, puzzleScores=[], puzzleStars=0, currentPuzzleDifficulty='easy';
let puzzleHintAudioSrc='', puzzleAttemptCount=0;

// Grammar state
let currentGrammarStage=0, grammarCorrectCount=0, grammarStars=0, currentGrammarDifficulty='easy';
let grammarCurrentAudio='', grammarExplanationAudio='', grammarAnswered=false;

if('webkitSpeechRecognition' in window){
    recognition=new webkitSpeechRecognition();
    recognition.continuous=false; recognition.interimResults=false; recognition.lang='en-US';
} else { alert('Your browser does not support speech recognition. Please use Chrome.'); }

window.addEventListener('DOMContentLoaded',()=>{
    loadStudentInfo();
    updateRepeatXpHint(); updateSpellXpHint(); updatePuzzleXpHint(); updateGrammarXpHint();
    const si=document.getElementById('spellingInput');
    if(si) si.addEventListener('keypress',e=>{if(e.key==='Enter')checkSpelling();});
    const pi=document.getElementById('puzzleInput');
    if(pi) pi.addEventListener('keypress',e=>{if(e.key==='Enter')checkPuzzle();});
    document.querySelector('.mascot').addEventListener('click',function(){
        this.style.animation='none'; setTimeout(()=>{this.style.animation='bounce 2s infinite';},10);
    });
    // Initialize roleplay badge for default role (teacher)
    updateRoleplayBadge('teacher');
    // Reset roleplay context for default role on page load
    fetch('/reset_roleplay_context',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({roleplay:'teacher'})}).catch(()=>{});
});

function capitalizeFirstLetter(s){return s?s.charAt(0).toUpperCase()+s.slice(1).toLowerCase():s;}

// ============================================================
//  ROLEPLAY ROLE BADGE
// ============================================================
const ROLE_META = {
    teacher:     { label:'üë©‚Äçüè´ Teacher Mode',     cls:'role-teacher',     msg:'I\'m your teacher today ‚Äî let\'s learn something new! üìö' },
    friend:      { label:'üë´ Friend Mode',       cls:'role-friend',      msg:'Hey! Great to hang out with you! What\'s up? üòÑ' },
    interviewer: { label:'üíº Interviewer Mode',  cls:'role-interviewer', msg:'Welcome! Please introduce yourself to begin the interview.' },
    viva:        { label:'üìö Viva Examiner Mode',cls:'role-viva',        msg:'Good day. Let\'s begin your oral examination.' },
};

function updateRoleplayBadge(role) {
    const el = document.getElementById('roleplayRoleBadge');
    if (!el) return;
    const meta = ROLE_META[role];
    if (meta) {
        el.innerHTML = `<span class="roleplay-role-badge ${meta.cls}">${meta.label}</span>`;
    } else {
        el.innerHTML = '';
    }
}

// ============================================================
//  LOAD STUDENT INFO
// ============================================================
async function loadStudentInfo(){
    try{
        const res=await fetch('/get_student_info'); const data=await res.json();
        if(data.success){
            const s=data.student;
            studentXP=s.xp||0; studentName=s.name||'Student'; studentId=s.userIdCode||'';
            unlockedFeatures=s.unlockedFeatures||['conversation'];
            modeXP.conversation=s.conversationXp||0; modeXP.roleplay=s.roleplayXp||0;
            modeXP.repeat=s.repeatXp||0; modeXP.spellbee=s.spellbeeXp||0; modeXP.meanings=s.meaningsXp||0;
            modeXP.wordpuzzle=s.wordpuzzleXp||0; modeXP.grammar=s.grammarXp||0;
            allBadgesData=s.badges||[]; earnedBadgeCount=s.earnedBadgeCount||0;
            totalBadgeCount=s.totalBadgeCount||0; currentStreak=s.streak||0;
            updateXPDisplay(); updateFeatureUI(); updateBadgeCountDisplay(); updateStreakDisplay();
            if(s.nextUnlock) showNextUnlockInfo(s.nextUnlock); else showNextUnlockInfo(null);
            if(s.dailyChallenge) loadDailyBanner(s.dailyChallenge,s.dailyCompleted);
        }
    }catch(e){console.error('Error loading student info:',e);}
}

// ============================================================
//  DAILY CHALLENGE
// ============================================================
function loadDailyBanner(challenge,completed){
    dailyChallengeData=challenge;
    const banner=document.getElementById('dailyBanner'),title=document.getElementById('dailyTitle'),desc=document.getElementById('dailyDesc');
    banner.style.display='flex';
    document.getElementById('dailyChallengeWord').textContent=challenge.word.toUpperCase();
    document.getElementById('dailyChallengeSentence').textContent=challenge.sentence;
    if(completed){
        banner.classList.add('completed'); title.textContent='‚úÖ Daily Challenge Completed!';
        desc.textContent='Great work! Come back tomorrow for a new challenge.'; banner.onclick=null; dailyXPClaimed=true;
    } else {
        title.textContent="üìÖ Today's Daily Challenge";
        desc.textContent=`Word: "${challenge.word.toUpperCase()}" ¬∑ Tap to practice & earn XP!`;
        banner.onclick=openDailyModal;
    }
}
function openDailyModal(){if(dailyXPClaimed)return;dailyWordDone=false;dailySentDone=false;showDailyStep(1);resetDailyUI();document.getElementById('dailyModalOverlay').classList.add('open');}
function closeDailyModal(){document.getElementById('dailyModalOverlay').classList.remove('open');try{window.speechSynthesis&&window.speechSynthesis.cancel();}catch(e){}}
function resetDailyUI(){
    const wr=document.getElementById('dailyWordResult'); wr.style.display='none'; wr.textContent='';
    document.getElementById('dailyWordNextBtn').style.display='none';
    const wb=document.getElementById('dailyWordRecordBtn'); wb.disabled=false; wb.textContent='üé§ Say the Word'; wb.classList.remove('recording');
    document.getElementById('dailySoundWave1').classList.remove('active');
    const sr=document.getElementById('dailySentResult'); sr.style.display='none'; sr.textContent='';
    document.getElementById('dailySentNextBtn').style.display='none';
    const sb=document.getElementById('dailySentRecordBtn'); sb.disabled=false; sb.textContent='üé§ Read the Sentence'; sb.classList.remove('recording');
    document.getElementById('dailySoundWave2').classList.remove('active');
}
function showDailyStep(n){
    [1,2,3].forEach(i=>{
        document.getElementById('dailyStep'+i).style.display=i===n?'block':'none';
        const el=document.getElementById('dStep'+i); el.classList.remove('active','done');
        if(i<n) el.classList.add('done'); else if(i===n) el.classList.add('active');
    });
}
function speakText(text,slow=false){if('speechSynthesis' in window){window.speechSynthesis.cancel();const u=new SpeechSynthesisUtterance(text);u.lang='en-US';u.rate=slow?0.6:0.9;u.pitch=1;window.speechSynthesis.speak(u);}}
function playDailyWordAudio(){if(dailyChallengeData)speakText(dailyChallengeData.word,true);}
function playDailySentenceAudio(){if(dailyChallengeData)speakText(dailyChallengeData.sentence,false);}
function recordDailyWord(){
    const btn=document.getElementById('dailyWordRecordBtn'),sw=document.getElementById('dailySoundWave1');
    btn.textContent='üé§ Listening...';btn.classList.add('recording');btn.disabled=true;sw.classList.add('active');
    const rec=new webkitSpeechRecognition(); rec.continuous=false; rec.interimResults=false; rec.lang='en-US'; rec.start();
    rec.onresult=e=>{
        const spoken=e.results[0][0].transcript.trim().toLowerCase();
        const target=dailyChallengeData.word.toLowerCase();
        btn.classList.remove('recording'); sw.classList.remove('active');
        const ok=spoken.includes(target)||target.includes(spoken)||levenshtein(spoken,target)<=2;
        const el=document.getElementById('dailyWordResult'); el.style.display='block';
        if(ok){el.className='daily-result success';el.innerHTML=`‚úÖ Great! You said: "<strong>${spoken}</strong>"`;dailyWordDone=true;document.getElementById('dailyWordNextBtn').style.display='block';btn.textContent='‚úÖ Word Done!';btn.disabled=true;}
        else{el.className='daily-result partial';el.innerHTML=`üîÑ You said: "<strong>${spoken}</strong>" ‚Äî try again! The word is <strong>${dailyChallengeData.word.toUpperCase()}</strong>`;btn.textContent='üé§ Try Again';btn.disabled=false;}
    };
    rec.onerror=()=>{btn.classList.remove('recording');sw.classList.remove('active');btn.textContent='üé§ Say the Word';btn.disabled=false;};
    rec.onend=()=>{if(!dailyWordDone){btn.classList.remove('recording');sw.classList.remove('active');btn.disabled=false;}};
}
function goToDailyStep2(){showDailyStep(2);}
function goToDailyStep3(){if(!dailySentDone){return;}showDailyStep(3);}
function recordDailySentence(){
    const btn=document.getElementById('dailySentRecordBtn'),sw=document.getElementById('dailySoundWave2');
    btn.textContent='üé§ Listening...';btn.classList.add('recording');btn.disabled=true;sw.classList.add('active');
    const rec=new webkitSpeechRecognition(); rec.continuous=false; rec.interimResults=false; rec.lang='en-US'; rec.start();
    rec.onresult=e=>{
        const spoken=e.results[0][0].transcript.trim().toLowerCase();
        const target=dailyChallengeData.sentence.toLowerCase();
        btn.classList.remove('recording'); sw.classList.remove('active');
        const spokenWords=spoken.split(/\s+/);
        const targetWords=target.replace(/[^a-z\s]/g,'').split(/\s+/);
        const matched=spokenWords.filter(w=>targetWords.includes(w)).length;
        const ratio=matched/targetWords.length;
        const el=document.getElementById('dailySentResult'); el.style.display='block';
        if(ratio>=0.5){el.className='daily-result success';el.innerHTML=`‚úÖ Well done! ${Math.round(ratio*100)}% words matched!`;dailySentDone=true;document.getElementById('dailySentNextBtn').style.display='block';btn.textContent='‚úÖ Sentence Done!';btn.disabled=true;}
        else if(ratio>=0.25){el.className='daily-result partial';el.innerHTML=`üîÑ Almost! ${Math.round(ratio*100)}% matched ‚Äî try reading more of the sentence!`;btn.textContent='üé§ Try Again';btn.disabled=false;}
        else{el.className='daily-result retry';el.innerHTML='üîÅ Try again! Speak clearly and read the whole sentence.';btn.textContent='üé§ Try Again';btn.disabled=false;}
    };
    rec.onerror=()=>{btn.classList.remove('recording');sw.classList.remove('active');btn.textContent='üé§ Read the Sentence';btn.disabled=false;};
    rec.onend=()=>{if(!dailySentDone){btn.classList.remove('recording');sw.classList.remove('active');btn.disabled=false;}};
}
async function claimDailyXP(){
    if(dailyXPClaimed)return;
    const btn=document.getElementById('dailyClaimBtn'); btn.textContent='‚è≥ Claiming...'; btn.disabled=true;
    const res=await fetch('/complete_daily',{method:'POST',headers:{'Content-Type':'application/json'}});
    const data=await res.json();
    if(data.success){
        dailyXPClaimed=true; createConfetti(); showXPGainPopup(3); studentXP+=3; updateXPDisplay();
        const banner=document.getElementById('dailyBanner'); banner.classList.add('completed');
        document.getElementById('dailyTitle').textContent='‚úÖ Daily Challenge Completed!';
        document.getElementById('dailyDesc').textContent='Amazing! +3 XP earned today! üî•'; banner.onclick=null;
        setTimeout(()=>closeDailyModal(),1800);
    } else {btn.textContent=data.message||'Already claimed!'; setTimeout(()=>closeDailyModal(),1500);}
}
function levenshtein(a,b){
    const dp=Array.from({length:a.length+1},(_,i)=>[i,...Array(b.length).fill(0)]);
    for(let j=0;j<=b.length;j++) dp[0][j]=j;
    for(let i=1;i<=a.length;i++) for(let j=1;j<=b.length;j++) dp[i][j]=a[i-1]===b[j-1]?dp[i-1][j-1]:1+Math.min(dp[i-1][j],dp[i][j-1],dp[i-1][j-1]);
    return dp[a.length][b.length];
}

// ============================================================
//  STREAK / XP DISPLAY
// ============================================================
function updateStreakDisplay(){const el=document.getElementById('streakBadge');if(!el)return;const s=currentStreak;const emoji=s>=7?'üî•üî•üî•':s>=3?'üî•üî•':'üî•';el.textContent=`${emoji} ${s} day${s!==1?'s':''} streak`;}

function updateXPDisplay(){
    const ne=document.getElementById('studentName');if(ne)ne.textContent='üë§ '+capitalizeFirstLetter(studentName);
    const ie=document.getElementById('studentId');
    if(ie){if(studentId){ie.textContent='ü™™ ID: '+studentId;ie.style.display='inline-block';}else{ie.style.display='none';}}
    const xe=document.getElementById('xpAmount');if(xe)xe.textContent=`${studentXP} XP Total`;
    ['conversation','roleplay','repeat','spellbee','wordpuzzle','grammar','meanings'].forEach(m=>updateModeXPDisplay(m,modeXP[m]||0));
}
function updateModeXPDisplay(mode,xp){
    const xe=document.getElementById(`${mode}Xp`),be=document.getElementById(`${mode}Progress`);
    if(!xe||!be)return;
    if(isFeatureUnlocked(mode)){const pct=Math.min((xp/XP_PER_UNLOCK)*100,100);xe.textContent=`${xp}/${XP_PER_UNLOCK}`;be.style.width=pct+'%';}
    else{xe.textContent='üîí';be.style.width='0%';}
}
function updateBadgeCountDisplay(){const b=document.getElementById('badgeCountBubble'),m=document.getElementById('badgeMiniCount');if(b)b.textContent=earnedBadgeCount;if(m)m.textContent=`üèÖ ${earnedBadgeCount} badge${earnedBadgeCount!==1?'s':''}`;}

// ============================================================
//  FEATURE UNLOCK
// ============================================================
function isFeatureUnlocked(f){return unlockedFeatures.includes(f);}
function getFeatureDisplayName(f){return {conversation:'Conversation',roleplay:'Roleplay',repeat:'Repeat',spellbee:'Spell Bee',wordpuzzle:'Word Puzzle',grammar:'Grammar',meanings:'üìñ Word Meanings (Bonus!)'}[f]||f;}
function updateFeatureUI(){
    document.querySelectorAll('.mode-btn').forEach(btn=>{
        const mode=btn.getAttribute('data-mode');
        let base=btn.textContent.replace(/^üîí\s*/,'').trim();
        if(isFeatureUnlocked(mode)){btn.disabled=false;btn.classList.remove('locked');if(mode==='meanings')btn.innerHTML='üìñ Meanings üéÅ';else btn.innerHTML=base;}
        else{btn.disabled=true;btn.classList.add('locked');btn.innerHTML='üîí '+base;}
    });
    document.querySelectorAll('.mode-xp-card').forEach(card=>{
        const mode=card.getAttribute('data-mode');
        isFeatureUnlocked(mode)?card.classList.remove('locked'):card.classList.add('locked');
    });
}
function showNextUnlockInfo(nextUnlock){
    const div=document.getElementById('nextUnlockInfo');if(!div)return;
    if(nextUnlock){
        const fname=getFeatureDisplayName(nextUnlock.feature);
        const mname=nextUnlock.current_mode.charAt(0).toUpperCase()+nextUnlock.current_mode.slice(1);
        if(nextUnlock.feature==='meanings'){div.innerHTML=`üéÅ <strong>Bonus Unlock Coming!</strong> Earn ${nextUnlock.xp_needed} more XP in Grammar to unlock <strong>Word Meanings</strong> as your bonus reward! üìñ`;}
        else{div.innerHTML=`üîì Next Unlock: <strong>${fname}</strong> <span style="margin-left:10px;color:#e17055;">(Earn ${nextUnlock.xp_needed} more XP in ${mname})</span>`;}
    } else {div.innerHTML='üéâ <strong>All features unlocked ‚Äî including the bonus!</strong> You\'re a champion! üèÜ';}
    div.style.display='block';
}

// ============================================================
//  DIFFICULTY HINTS
// ============================================================
function updateRepeatXpHint(){const sel=document.getElementById('difficultySelect'),hint=document.getElementById('repeatDiffHint');if(!sel||!hint)return;const diff=sel.value;currentRepeatDifficulty=diff;const xp=DIFFICULTY_XP[diff];hint.innerHTML=`üí° ${diff.charAt(0).toUpperCase()+diff.slice(1)}: <span class="difficulty-xp-badge diff-${diff}">+${xp} XP per stage</span>`;}
function updateSpellXpHint(){const sel=document.getElementById('spellDifficultySelect'),hint=document.getElementById('spellDiffHint');if(!sel||!hint)return;const diff=sel.value;currentSpellDifficulty=diff;const xp=DIFFICULTY_XP[diff];hint.innerHTML=`üí° ${diff.charAt(0).toUpperCase()+diff.slice(1)}: <span class="difficulty-xp-badge diff-${diff}">+${xp} XP per stage</span>`;}
function updatePuzzleXpHint(){const sel=document.getElementById('puzzleDifficultySelect'),hint=document.getElementById('puzzleDiffHint');if(!sel||!hint)return;const diff=sel.value;currentPuzzleDifficulty=diff;const xp=DIFFICULTY_XP[diff];hint.innerHTML=`üí° ${diff.charAt(0).toUpperCase()+diff.slice(1)}: <span class="difficulty-xp-badge diff-${diff}">+${xp} XP per puzzle</span>`;}
function updateGrammarXpHint(){const sel=document.getElementById('grammarDifficultySelect'),hint=document.getElementById('grammarDiffHint');if(!sel||!hint)return;const diff=sel.value;currentGrammarDifficulty=diff;const xp=DIFFICULTY_XP[diff];hint.innerHTML=`üí° ${diff.charAt(0).toUpperCase()+diff.slice(1)}: <span class="difficulty-xp-badge diff-${diff}">+${xp} XP per question</span>`;}

// ============================================================
//  AWARD XP
// ============================================================
async function awardXP(xpAmount,mode,score,stars,difficulty,attempt){
    showXPGainPopup(xpAmount);
    try{
        const body={xpEarned:xpAmount,mode,score,starsEarned:stars,difficulty:difficulty||'easy'};
        if(attempt!==undefined)body.attempt=attempt;
        const res=await fetch('/update_xp',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
        const data=await res.json();
        if(data.success){
            studentXP=data.newXP; modeXP[mode]=data.newModeXP; unlockedFeatures=data.unlockedFeatures||unlockedFeatures;
            if(data.streak!==undefined){currentStreak=data.streak;updateStreakDisplay();}
            updateXPDisplay(); updateFeatureUI();
            if(data.newlyUnlockedFeatures&&data.newlyUnlockedFeatures.length>0)setTimeout(()=>showFeatureUnlockAnimation(data.newlyUnlockedFeatures),500);
            if(data.newlyEarnedBadges&&data.newlyEarnedBadges.length>0){
                data.newlyEarnedBadges.forEach((badge,i)=>{setTimeout(()=>showBadgeToast(badge),i*1200);earnedBadgeCount++;const found=allBadgesData.find(b=>b.id===badge.id);if(found){found.earned=true;found.earned_at=new Date().toISOString();}});
                updateBadgeCountDisplay();
            }
            if(data.nextUnlock) showNextUnlockInfo(data.nextUnlock); else showNextUnlockInfo(null);
        }
    }catch(e){console.error('Error updating XP:',e);}
}
function showXPGainPopup(xpAmount){const p=document.createElement('div');p.className='xp-gain-popup';p.textContent=`+${xpAmount} XP üéâ`;document.body.appendChild(p);setTimeout(()=>p.remove(),3000);}
function showFeatureUnlockAnimation(newlyUnlocked){
    createConfetti();const isBonus=newlyUnlocked[0]==='meanings';
    const n=document.createElement('div');n.className=isBonus?'unlock-notification bonus':'unlock-notification';
    const label=isBonus?'üéÅ BONUS MODE UNLOCKED! üéÅ':'üéâ NEW FEATURE UNLOCKED! üéâ';
    n.innerHTML=`<div>${label}</div><div style="font-size:48px;margin:20px 0">${isBonus?'üìñ':'üîì'}</div><div style="font-size:28px"><strong>${getFeatureDisplayName(newlyUnlocked[0])}</strong></div>`;
    document.body.appendChild(n);setTimeout(()=>{n.remove();updateFeatureUI();},4000);
}
function showBadgeToast(badge){
    const c=document.getElementById('badgeToastContainer'),t=document.createElement('div');t.className='badge-toast';
    t.innerHTML=`<span class="badge-toast-icon">${badge.icon}</span><div class="badge-toast-text"><div class="badge-toast-title">üèÖ Badge Unlocked!</div><div>${badge.name}</div><div style="font-size:12px;font-weight:normal;color:#636e72">${badge.description}</div></div>`;
    c.appendChild(t);setTimeout(()=>t.remove(),4200);
}

// ============================================================
//  BADGES PANEL
// ============================================================
function openBadgesPanel(){renderBadgesPanel();document.getElementById('badgesPanelOverlay').classList.add('open');}
function closeBadgesPanel(){document.getElementById('badgesPanelOverlay').classList.remove('open');}
function closeBadgesPanelOutside(e){if(e.target===document.getElementById('badgesPanelOverlay'))closeBadgesPanel();}
function renderBadgesPanel(){
    const subtitle=document.getElementById('badgePanelSubtitle'),bar=document.getElementById('badgeProgressBarFill'),content=document.getElementById('badgePanelContent');
    const pct=totalBadgeCount>0?Math.round((earnedBadgeCount/totalBadgeCount)*100):0;
    subtitle.textContent=`${earnedBadgeCount} / ${totalBadgeCount} badges earned (${pct}%)`;bar.style.width=pct+'%';
    const cats={milestone:'üåü Milestone',conversation:'üí¨ Conversation',roleplay:'üé≠ Roleplay',repeat:'üîÅ Repeat',spellbee:'üêù Spell Bee',wordpuzzle:'üß© Word Puzzle',grammar:'üìù Grammar',meanings:'üìñ Meanings (Bonus)',stars:'‚≠ê Stars',perfect:'üéØ Perfect Score',streak:'üî• Streak',special:'üåà Special'};
    const grouped={};
    allBadgesData.forEach(b=>{if(!grouped[b.category])grouped[b.category]=[];grouped[b.category].push(b);});
    let html='';
    Object.keys(cats).forEach(cat=>{
        const items=grouped[cat];if(!items||!items.length)return;
        html+=`<div class="badge-category-title">${cats[cat]}</div><div class="badge-grid">`;
        items.forEach(b=>{const ds=b.earned&&b.earned_at?`<div class="badge-card-date">‚úÖ ${new Date(b.earned_at).toLocaleDateString()}</div>`:'';html+=`<div class="badge-card ${b.earned?'earned':''}" title="${b.description}"><span class="badge-locked-icon">üîí</span><span class="badge-card-icon">${b.icon}</span><div class="badge-card-name">${b.name}</div><div class="badge-card-desc">${b.description}</div>${ds}</div>`;});
        html+='</div>';
    });
    content.innerHTML=html||'<p style="text-align:center;color:#999;padding:30px">No badges yet. Start playing!</p>';
}

// ============================================================
//  LEADERBOARD
// ============================================================
async function openLeaderboard(){
    document.getElementById('leaderboardOverlay').classList.add('open');
    const content=document.getElementById('leaderboardContent'),rankInfo=document.getElementById('myRankInfo');
    content.innerHTML='<div style="text-align:center;padding:30px;color:#999;">Loading...</div>';
    try{
        const res=await fetch('/get_leaderboard');const data=await res.json();
        if(data.success){
            const medals=['ü•á','ü•à','ü•â'],rc=['top1','top2','top3'];let html='';
            data.leaderboard.forEach((row,i)=>{const cls=i<3?rc[i]:'other';const ri=i<3?medals[i]:`#${row.rank}`;html+=`<div class="leaderboard-row ${cls}"><span class="lb-rank">${ri}</span><span class="lb-name">${row.name}</span><span class="lb-xp">${row.xp} XP</span><span class="lb-streak">üî•${row.streak}</span></div>`;});
            content.innerHTML=html||'<p style="text-align:center;color:#999">No students yet</p>';
            rankInfo.textContent=data.my_rank<=10?`üéâ You're in the top ${data.my_rank}!`:`You're ranked #${data.my_rank}. Keep practicing!`;
        }
    }catch(e){content.innerHTML='<p style="color:#d63031;text-align:center">Failed to load leaderboard</p>';}
}
function closeLeaderboard(){document.getElementById('leaderboardOverlay').classList.remove('open');}
function closeLeaderboardOutside(e){if(e.target===document.getElementById('leaderboardOverlay'))closeLeaderboard();}

// ============================================================
//  MISC UTILS
// ============================================================
function exitToHome(){stopAllMicAndAudio();if(confirm('Exit to home page?'))window.location.href='/dashboard';}
function stopAllMicAndAudio(){
    try{recognition.stop();}catch(e){}
    window.speechSynthesis&&window.speechSynthesis.cancel();
    if(currentAudioPlaying){currentAudioPlaying.pause();currentAudioPlaying.currentTime=0;currentAudioPlaying=null;}
    ['micBtn','roleplayMicBtn','repeatMicBtn'].forEach(id=>{const b=document.getElementById(id);if(b){b.classList.remove('recording');b.disabled=false;}});
    const mb=document.getElementById('micBtn'),rb=document.getElementById('roleplayMicBtn'),rmb=document.getElementById('repeatMicBtn');
    if(mb)mb.textContent='üé§ Click to Speak';if(rb)rb.textContent='üé§ Click to Speak';if(rmb&&rmb.style.display!=='none')rmb.textContent='üé§ Repeat';
    document.querySelectorAll('.sound-wave').forEach(w=>w.classList.remove('active'));
}
function createConfetti(){
    const colors=['#ffd700','#ff6b6b','#4ecdc4','#45b7d1','#f39c12','#e74c3c'];
    for(let i=0;i<50;i++){const c=document.createElement('div');c.className='confetti';c.style.left=Math.random()*100+'%';c.style.background=colors[Math.floor(Math.random()*colors.length)];c.style.animationDelay=Math.random()*3+'s';c.style.animationDuration=(Math.random()*2+2)+'s';document.body.appendChild(c);setTimeout(()=>c.remove(),5000);}
}
function switchMode(mode,event){
    if(!isFeatureUnlocked(mode)){
        const msg=mode==='meanings'?'üéÅ Word Meanings is a Bonus Mode!\n\nComplete Grammar Mode to unlock it as your special reward!':`üîí ${getFeatureDisplayName(mode)} Mode is locked!\n\nComplete challenges to unlock it.`;
        alert(msg); return;
    }
    stopAllMicAndAudio();currentMode=mode;
    document.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('active'));
    if(event&&event.target)event.target.classList.add('active');
    ['conversationMode','roleplayMode','repeatMode','spellbeeMode','meaningsMode','wordpuzzleMode','grammarMode'].forEach(id=>document.getElementById(id).classList.add('hidden'));
    const modeMap={conversation:'conversationMode',roleplay:'roleplayMode',repeat:'repeatMode',spellbee:'spellbeeMode',meanings:'meaningsMode',wordpuzzle:'wordpuzzleMode',grammar:'grammarMode'};
    document.getElementById(modeMap[mode]).classList.remove('hidden');
    if(mode==='repeat')resetStage();
    else if(mode==='spellbee')resetSpellBee();
    else if(mode==='wordpuzzle')resetPuzzle();
    else if(mode==='grammar')resetGrammar();
    // When switching to roleplay, ensure context is reset for the current role
    else if(mode==='roleplay'){
        const role=document.getElementById('roleplaySelect').value||'teacher';
        fetch('/reset_roleplay_context',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({roleplay:role})}).catch(()=>{});
    }
}
function buildScoreBar(score){const cls=score>=90?'green':score>=60?'yellow':'red';return `<div class="score-bar-container"><div class="score-bar-label">üìä Score: ${score}%</div><div class="score-bar-track"><div class="score-bar-fill ${cls}" style="width:0%" data-target="${score}"></div></div></div>`;}
function animateScoreBars(){document.querySelectorAll('.score-bar-fill[data-target]').forEach(el=>{const t=el.getAttribute('data-target');setTimeout(()=>{el.style.width=t+'%';el.textContent=t+'%';},100);});}
function sequenceSimilarity(a,b){a=a.toLowerCase();b=b.toLowerCase();let m=0;for(let i=0;i<Math.min(a.length,b.length);i++)if(a[i]===b[i])m++;return m/Math.max(a.length,b.length);}

// ============================================================
//  CONVERSATION
// ============================================================
function startRecording(){
    const btn=document.getElementById('micBtn'),sw=document.getElementById('soundWave1');
    btn.textContent='üé§ Listening...';btn.classList.add('recording');btn.disabled=true;sw.classList.add('active');
    recognition.start();
    recognition.onresult=e=>{const t=e.results[0][0].transcript;addMessage(t,'user');sendToAI(t,null);};
    recognition.onerror=()=>{btn.textContent='üé§ Click to Speak';btn.classList.remove('recording');btn.disabled=false;sw.classList.remove('active');};
    recognition.onend=()=>{btn.textContent='üé§ Click to Speak';btn.classList.remove('recording');btn.disabled=false;sw.classList.remove('active');};
}
function addMessage(text,sender,chatAreaId='chatArea'){
    const area=document.getElementById(chatAreaId),div=document.createElement('div');
    div.className=sender==='user'?'message user-msg':'message ai-msg';div.textContent=text;
    area.appendChild(div);area.scrollTop=area.scrollHeight;
}
function sendToAI(text,roleplay){
    const chatAreaId=roleplay?'roleplayChatArea':'chatArea';
    addMessage('Thinking...','ai',chatAreaId);
    fetch('/process',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text,roleplay})})
    .then(r=>r.json()).then(data=>{
        const area=document.getElementById(chatAreaId);area.removeChild(area.lastChild);
        addMessage(data.reply,'ai',chatAreaId);
        if(data.audio){const audio=new Audio(data.audio);currentAudioPlaying=audio;audio.play();
            audio.onended=()=>{currentAudioPlaying=null;awardXP(5,'conversation',100,1,'easy');if(autoReactivate&&currentMode==='conversation')setTimeout(startRecording,500);};}
    }).catch(()=>{const area=document.getElementById(chatAreaId);area.removeChild(area.lastChild);addMessage('Sorry, something went wrong!','ai',chatAreaId);});
}

// ============================================================
//  ROLEPLAY  ‚Äî Normal Coach removed; a role is always required
// ============================================================
async function handleRoleplayChange(){
    const role=document.getElementById('roleplaySelect').value;
    // role is now always one of: teacher, friend, interviewer, viva
    stopAllMicAndAudio();
    updateRoleplayBadge(role);
    try{await fetch('/reset_roleplay_context',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({roleplay:role})});}catch(e){console.error('Failed to reset roleplay context:',e);}
    const chatArea=document.getElementById('roleplayChatArea'); chatArea.innerHTML='';
    const welcomeMessages={
        teacher:     'üë©‚Äçüè´ Teacher mode started! I\'m your teacher ‚Äî ready to learn? Let\'s begin! üìö',
        friend:      'üë´ Friend mode started! Hey! So happy to chat with you. What\'s up? üòÑ',
        interviewer: 'üíº Interview mode started! Welcome. Please take a seat and introduce yourself.',
        viva:        'üìö Viva mode started! Good day. Let\'s begin your examination. Tell me about your project.',
    };
    addMessage(welcomeMessages[role]||welcomeMessages['teacher'],'ai','roleplayChatArea');
    const roleLabels={teacher:'üë©‚Äçüè´ Teacher',friend:'üë´ Friend',interviewer:'üíº Interviewer',viva:'üìö Viva Examiner'};
    showRoleplaySwitchToast(`New chat started with ${roleLabels[role]||role}!`);
}
function showRoleplaySwitchToast(message){const existing=document.querySelector('.roleplay-switch-toast');if(existing)existing.remove();const toast=document.createElement('div');toast.className='roleplay-switch-toast';toast.innerHTML=`üé≠ ${message}`;document.body.appendChild(toast);setTimeout(()=>toast.remove(),3200);}
function startRoleplayRecording(){
    const btn=document.getElementById('roleplayMicBtn'),sw=document.getElementById('soundWave3');
    const role=document.getElementById('roleplaySelect').value||'teacher';
    btn.textContent='üé§ Listening...';btn.classList.add('recording');btn.disabled=true;sw.classList.add('active');
    recognition.start();
    recognition.onresult=e=>{const t=e.results[0][0].transcript;addMessage(t,'user','roleplayChatArea');sendToAIRoleplay(t,role);};
    recognition.onerror=()=>{btn.textContent='üé§ Click to Speak';btn.classList.remove('recording');btn.disabled=false;sw.classList.remove('active');};
    recognition.onend=()=>{btn.textContent='üé§ Click to Speak';btn.classList.remove('recording');btn.disabled=false;sw.classList.remove('active');};
}
function sendToAIRoleplay(text,roleplay){
    addMessage('Thinking...','ai','roleplayChatArea');
    fetch('/process',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text,roleplay})})
    .then(r=>r.json()).then(data=>{
        const area=document.getElementById('roleplayChatArea');area.removeChild(area.lastChild);
        addMessage(data.reply,'ai','roleplayChatArea');
        if(data.audio){const audio=new Audio(data.audio);currentAudioPlaying=audio;audio.play();
            audio.onended=()=>{currentAudioPlaying=null;awardXP(8,'roleplay',100,1,'easy');if(autoReactivate&&currentMode==='roleplay')setTimeout(startRoleplayRecording,500);};}
    }).catch(()=>{const a=document.getElementById('roleplayChatArea');a.removeChild(a.lastChild);addMessage('Sorry, something went wrong!','ai','roleplayChatArea');});
}

// ============================================================
//  REPEAT
// ============================================================
function resetStage(){currentStage=0;stageScores=[];totalStars=0;updateProgress();document.getElementById('repeatSentence').textContent='Click "Start Stage" to begin! üöÄ';document.getElementById('startBtn').style.display='block';document.getElementById('slowBtn').style.display='none';document.getElementById('repeatMicBtn').style.display='none';document.getElementById('repeatFeedback').innerHTML='';}
function startStage(){currentRepeatDifficulty=document.getElementById('difficultySelect').value;currentStage=0;stageScores=[];totalStars=0;getNewSentence();document.getElementById('startBtn').style.display='none';}
function getNewSentence(){
    if(currentStage>=totalStages){showCompletionModal();return;}
    currentStage++;updateProgress();document.getElementById('repeatSentence').textContent='Loading... ‚è≥';document.getElementById('repeatFeedback').innerHTML='';
    fetch('/repeat_sentence',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({category:document.getElementById('categorySelect').value,difficulty:currentRepeatDifficulty})})
    .then(r=>r.json()).then(data=>{
        currentSentence=data.sentence;currentAudioSlow=data.audio_slow;
        document.getElementById('repeatSentence').textContent=data.sentence;
        document.getElementById('slowBtn').style.display='block';document.getElementById('repeatMicBtn').style.display='block';
        if(data.audio){const a=new Audio(data.audio);currentAudioPlaying=a;a.play();a.onended=()=>{currentAudioPlaying=null;};}
    });
}
function playSlow(){if(currentAudioSlow){const a=new Audio(currentAudioSlow);currentAudioPlaying=a;a.play();a.onended=()=>{currentAudioPlaying=null;};}}
function recordRepeat(){
    const btn=document.getElementById('repeatMicBtn'),sw=document.getElementById('soundWave2');
    btn.textContent='üé§ Listening...';btn.classList.add('recording');btn.disabled=true;sw.classList.add('active');
    recognition.start();
    recognition.onresult=e=>{checkPronunciation(e.results[0][0].transcript);};
    recognition.onerror=()=>{btn.textContent='üé§ Repeat';btn.classList.remove('recording');btn.disabled=false;sw.classList.remove('active');};
    recognition.onend=()=>{btn.textContent='üé§ Repeat';btn.classList.remove('recording');btn.disabled=false;sw.classList.remove('active');};
}
function checkPronunciation(studentText){
    fetch('/check_repeat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({student:studentText,correct:currentSentence})})
    .then(r=>r.json()).then(data=>{
        stageScores.push(data.score);totalStars+=data.stars;if(data.stars===3)createConfetti();
        let compHTML='<div style="margin:20px 0;font-size:20px;line-height:2;">';
        data.word_comparison.forEach(w=>{const cls=w.status==='correct'?'word-correct':w.status==='incorrect'?'word-incorrect':'word-missing';compHTML+=`<span class="word-highlight ${cls}">${w.word}</span> `;});
        compHTML+='</div>';
        const scoreBar=buildScoreBar(data.score);
        document.getElementById('repeatFeedback').innerHTML=`<div class="stars-display" style="font-size:48px;text-align:center;margin:15px 0;"></div>${compHTML}<div class="feedback">${data.feedback}${scoreBar}</div>`;
        animateScoreBars();
        for(let i=0;i<3;i++){setTimeout(()=>{const s=document.createElement('span');s.className=i<data.stars?'star filled':'star empty';s.textContent='‚≠ê';const sd=document.getElementById('repeatFeedback').querySelector('.stars-display');if(sd)sd.appendChild(s);},i*300);}
        document.getElementById('currentScore').textContent=data.score;document.getElementById('totalScore').textContent=totalStars;
        updateAccuracy();updateBadges();
        if(currentStage>=totalStages){const avg=stageScores.reduce((a,b)=>a+b,0)/stageScores.length;const xpp=DIFFICULTY_XP[currentRepeatDifficulty]||1;const swx=stageScores.filter(s=>s>=60).length;const tx=xpp*swx;const pb=totalStars===15?5:0;const fx=tx+pb;if(fx>0)awardXP(fx,'repeat',avg,totalStars,currentRepeatDifficulty);}
        setTimeout(getNewSentence,3000);
    });
}
function updateProgress(){const pct=(currentStage/totalStages)*100,pf=document.getElementById('progressFill');pf.style.width=pct+'%';pf.textContent=`${currentStage}/${totalStages} üöÄ`;}
function updateAccuracy(){if(!stageScores.length){document.getElementById('accuracy').textContent='0%';return;}document.getElementById('accuracy').textContent=Math.round(stageScores.reduce((a,b)=>a+b,0)/stageScores.length)+'%';}
function updateBadges(){if(totalStars>=5)document.getElementById('badge1').classList.add('unlocked');if(totalStars>=10)document.getElementById('badge2').classList.add('unlocked');if(totalStars>=15)document.getElementById('badge3').classList.add('unlocked');}
function showCompletionModal(){
    createConfetti();const ms=document.getElementById('modalStars');ms.innerHTML='';
    const fsc=Math.floor(totalStars/5);
    for(let i=0;i<3;i++){setTimeout(()=>{const s=document.createElement('span');s.className=i<fsc?'star filled':'star empty';s.textContent='‚≠ê';ms.appendChild(s);},i*300);}
    document.getElementById('modalScore').textContent=`${totalStars}/15 Stars`;
    const msgs=['üí™ Keep practicing!','üëç Good effort! Try again!','üéâ Great job! Keep practicing!','üèÜ Perfect! You are amazing!'];
    document.getElementById('modalMessage').textContent=totalStars>=13?msgs[3]:totalStars>=10?msgs[2]:totalStars>=7?msgs[1]:msgs[0];
    document.getElementById('completionModal').classList.add('active');
}
function closeModal(){
    document.getElementById('completionModal').classList.remove('active');
    if(currentMode==='repeat'){resetStage();totalStars=0;document.getElementById('totalScore').textContent='0';document.getElementById('accuracy').textContent='0%';document.querySelectorAll('#repeatMode .badge').forEach(b=>b.classList.remove('unlocked'));}
    else if(currentMode==='spellbee'){resetSpellBee();spellTotalStars=0;document.getElementById('spellTotalScore').textContent='0';document.getElementById('spellAccuracy').textContent='0%';['spellBadge1','spellBadge2','spellBadge3'].forEach(id=>document.getElementById(id).classList.remove('unlocked'));}
    else if(currentMode==='wordpuzzle')resetPuzzle();
    else if(currentMode==='grammar')resetGrammar();
}

// ============================================================
//  SPELL BEE
// ============================================================
function resetSpellBee(){
    currentSpellStage=0;spellStageScores=[];spellTotalStars=0;spellAttemptCount=0;
    updateSpellProgress();
    document.getElementById('spellWord').textContent='Click "Start Spelling" to begin! üêù';
    document.getElementById('spellStartBtn').style.display='block';
    ['playWordBtn','playUsageBtn','checkSpellBtn'].forEach(id=>document.getElementById(id).style.display='none');
    document.getElementById('spellInputContainer').style.display='none';
    document.getElementById('spellFeedback').innerHTML='';
    document.getElementById('spellingInput').value='';
}
function startSpelling(){currentSpellDifficulty=document.getElementById('spellDifficultySelect').value;currentSpellStage=0;spellStageScores=[];spellTotalStars=0;getNewWord();document.getElementById('spellStartBtn').style.display='none';}
function getNewWord(){
    if(currentSpellStage>=totalStages){showSpellCompletionModal();return;}
    currentSpellStage++;spellAttemptCount=0;updateSpellProgress();
    document.getElementById('spellWord').textContent='Loading... ‚è≥';
    document.getElementById('spellFeedback').innerHTML='';document.getElementById('spellingInput').value='';
    fetch('/spell_word',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({difficulty:currentSpellDifficulty})})
    .then(r=>r.json()).then(data=>{
        currentWord=data.word;currentWordAudio=data.audio_word;currentUsageAudio=data.audio_sentence;
        document.getElementById('spellWord').textContent='üéß Listen carefully and spell the word!';
        ['playWordBtn','playUsageBtn','checkSpellBtn'].forEach(id=>document.getElementById(id).style.display='block');
        document.getElementById('spellInputContainer').style.display='block';
        if(data.audio_word){const a=new Audio(data.audio_word);currentAudioPlaying=a;a.play();a.onended=()=>{currentAudioPlaying=null;};}
        setTimeout(()=>document.getElementById('spellingInput').focus(),500);
    });
}
function playWordAgain(){if(currentWordAudio){const a=new Audio(currentWordAudio);currentAudioPlaying=a;a.play();a.onended=()=>{currentAudioPlaying=null;};}}
function playUsageAgain(){if(currentUsageAudio){const a=new Audio(currentUsageAudio);currentAudioPlaying=a;a.play();a.onended=()=>{currentAudioPlaying=null;};}}
function checkSpelling(){
    const val=document.getElementById('spellingInput').value;if(!val.trim()){alert('Please type your spelling first!');return;}
    spellAttemptCount++;
    fetch('/check_spelling',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({spelling:val,correct:currentWord,attempt:spellAttemptCount})})
    .then(r=>r.json()).then(data=>{
        spellStageScores.push(data.correct?100:0);spellTotalStars+=data.stars;if(data.stars===3)createConfetti();
        let compHTML='<div style="margin:20px 0;font-size:24px;line-height:2;">';
        data.letter_comparison.forEach(l=>{const cls=l.status==='correct'?'letter-correct':l.status==='incorrect'?'letter-incorrect':'letter-missing';compHTML+=`<span class="letter-highlight ${cls}">${l.letter.toUpperCase()}</span> `;});
        compHTML+='</div>';
        const simScore=data.correct?100:Math.round(sequenceSimilarity(val,currentWord)*100);
        const scoreBar=buildScoreBar(simScore);const hintHTML=data.hint?`<div class="hint-box">üí° ${data.hint}</div>`:'';
        document.getElementById('spellFeedback').innerHTML=`<div class="stars-display" style="font-size:48px;text-align:center;margin:15px 0;"></div>${compHTML}<div class="feedback">${data.feedback}${!data.correct?`<br><br>Correct spelling: <strong>${data.correct_spelling.toUpperCase()}</strong>`:''}</div>${scoreBar}${hintHTML}`;
        animateScoreBars();
        for(let i=0;i<3;i++){setTimeout(()=>{const s=document.createElement('span');s.className=i<data.stars?'star filled':'star empty';s.textContent='‚≠ê';const sd=document.getElementById('spellFeedback').querySelector('.stars-display');if(sd)sd.appendChild(s);},i*300);}
        document.getElementById('spellCurrentScore').textContent=data.correct?'100':'0';document.getElementById('spellTotalScore').textContent=spellTotalStars;
        updateSpellAccuracy();updateSpellBadges();
        if(currentSpellStage>=totalStages){const avg=spellStageScores.reduce((a,b)=>a+b,0)/spellStageScores.length;const xpp=DIFFICULTY_XP[currentSpellDifficulty]||1;const swx=spellStageScores.filter(s=>s>=1).length;const tx=xpp*swx;const pb=spellTotalStars===15?5:0;const fx=tx+pb;if(fx>0)awardXP(fx,'spellbee',avg,spellTotalStars,currentSpellDifficulty);}
        setTimeout(getNewWord,3500);
    });
}
function updateSpellProgress(){const pct=(currentSpellStage/totalStages)*100,pf=document.getElementById('spellProgressFill');pf.style.width=pct+'%';pf.textContent=`${currentSpellStage}/${totalStages} üêù`;}
function updateSpellAccuracy(){if(!spellStageScores.length){document.getElementById('spellAccuracy').textContent='0%';return;}document.getElementById('spellAccuracy').textContent=Math.round(spellStageScores.reduce((a,b)=>a+b,0)/spellStageScores.length)+'%';}
function updateSpellBadges(){if(spellTotalStars>=5)document.getElementById('spellBadge1').classList.add('unlocked');if(spellTotalStars>=10)document.getElementById('spellBadge2').classList.add('unlocked');if(spellTotalStars>=15)document.getElementById('spellBadge3').classList.add('unlocked');}
function showSpellCompletionModal(){
    createConfetti();const ms=document.getElementById('modalStars');ms.innerHTML='';
    const fsc=Math.floor(spellTotalStars/5);
    for(let i=0;i<3;i++){setTimeout(()=>{const s=document.createElement('span');s.className=i<fsc?'star filled':'star empty';s.textContent='‚≠ê';ms.appendChild(s);},i*300);}
    document.getElementById('modalScore').textContent=`${spellTotalStars}/15 Stars`;
    document.getElementById('modalMessage').textContent=spellTotalStars>=13?'üèÜ Perfect Spelling Champion! üèÜ':spellTotalStars>=10?'üéâ Great spelling skills! üéâ':spellTotalStars>=7?'üëç Good effort! Practice more! üëç':'üí™ Keep practicing spelling! üí™';
    document.getElementById('completionModal').classList.add('active');
}

// ============================================================
//  WORD MEANINGS
// ============================================================
function getMeaning(){
    const word=document.getElementById('wordInput').value.trim();if(!word){alert('Please type a word first!');return;}
    const sw=document.getElementById('soundWave5');sw.classList.add('active');
    document.getElementById('wordMeaningDisplay').innerHTML=`<div style="text-align:center;color:#667eea;font-size:20px;padding:60px 20px;"><span style="font-size:80px;display:block;margin-bottom:20px;">üîç</span>Finding the meaning of "${word}"...</div>`;
    fetch('/get_meaning',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({word})})
    .then(r=>r.json()).then(data=>{
        sw.classList.remove('active');
        document.getElementById('wordMeaningDisplay').innerHTML=`<div style="text-align:center;margin-bottom:30px;"><h2 style="font-size:42px;color:#667eea;margin-bottom:10px;font-family:'Fredoka One',cursive;">${data.word.toUpperCase()}</h2><span style="font-size:18px;color:#999;font-style:italic;">(${data.type})</span></div><div class="meaning-section"><div class="meaning-label"><span style="font-size:24px;">üí°</span> Meaning</div><div class="meaning-text">${data.meaning}</div></div><div class="meaning-section"><div class="meaning-label"><span style="font-size:24px;">üìù</span> Example</div><div class="meaning-text">"${data.usage}"</div></div><div class="meaning-section"><div class="meaning-label"><span style="font-size:24px;">üí≠</span> Helpful Tip</div><div class="meaning-text">${data.tip}</div></div><div style="text-align:center;margin-top:30px;"><button class="mic-btn" onclick="playMeaningAudio('${data.audio}')">üîä Listen to Explanation</button></div>`;
        if(data.audio){const a=new Audio(data.audio);currentAudioPlaying=a;a.play();a.onended=()=>{currentAudioPlaying=null;awardXP(10,'meanings',100,1,'easy');};}
    }).catch(()=>{sw.classList.remove('active');document.getElementById('wordMeaningDisplay').innerHTML=`<div style="text-align:center;color:#d63031;font-size:20px;padding:60px 20px;"><span style="font-size:80px;display:block;margin-bottom:20px;">‚ùå</span>Sorry, I couldn't find the meaning. Please try another word!</div>`;});
}
function playMeaningAudio(path){if(path){const a=new Audio(path);currentAudioPlaying=a;a.play();a.onended=()=>{currentAudioPlaying=null;};}}

// ============================================================
//  WORD PUZZLE
// ============================================================
function resetPuzzle(){
    currentPuzzleStage=0;puzzleScores=[];puzzleStars=0;puzzleAttemptCount=0;
    updatePuzzleProgress();
    document.getElementById('puzzleDisplayBox').innerHTML='<div>Click "Start Puzzle" to play! üß©</div>';
    document.getElementById('puzzleHintBox').style.display='none';
    document.getElementById('puzzleInputContainer').style.display='none';
    document.getElementById('puzzleInput').value='';
    document.getElementById('puzzleFeedback').innerHTML='';
    document.getElementById('puzzleStartBtn').style.display='block';
    document.getElementById('puzzleHintAudioBtn').style.display='none';
    document.getElementById('puzzleCheckBtn').style.display='none';
    document.getElementById('puzzleSolved').textContent='0';
    document.getElementById('puzzleStars').textContent='0';
    document.getElementById('puzzleAccuracy').textContent='0%';
}
function startPuzzle(){
    currentPuzzleDifficulty=document.getElementById('puzzleDifficultySelect').value;
    currentPuzzleStage=0;puzzleScores=[];puzzleStars=0;
    getNewPuzzle();document.getElementById('puzzleStartBtn').style.display='none';
}
function getNewPuzzle(){
    if(currentPuzzleStage>=totalStages){showPuzzleCompletionModal();return;}
    currentPuzzleStage++;puzzleAttemptCount=0;updatePuzzleProgress();
    document.getElementById('puzzleDisplayBox').innerHTML='<div>‚è≥ Loading puzzle...</div>';
    document.getElementById('puzzleFeedback').innerHTML='';document.getElementById('puzzleInput').value='';
    fetch('/word_puzzle_start',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({difficulty:currentPuzzleDifficulty})})
    .then(r=>r.json()).then(data=>{
        puzzleHintAudioSrc=data.hint_audio||'';
        document.getElementById('puzzleDisplayBox').innerHTML=`<div class="puzzle-scrambled">${data.scrambled}</div><div class="puzzle-meta"><span class="puzzle-tag">üìÅ ${data.category}</span><span class="puzzle-tag">üî¢ ${data.length} letters</span></div>`;
        document.getElementById('puzzleHintText').textContent=data.hint;
        document.getElementById('puzzleHintBox').style.display='block';
        document.getElementById('puzzleInputContainer').style.display='block';
        document.getElementById('puzzleHintAudioBtn').style.display='block';
        document.getElementById('puzzleCheckBtn').style.display='block';
        if(data.hint_audio){const a=new Audio(data.hint_audio);currentAudioPlaying=a;a.play();a.onended=()=>{currentAudioPlaying=null;};}
        setTimeout(()=>document.getElementById('puzzleInput').focus(),400);
    });
}
function playPuzzleHintAudio(){if(puzzleHintAudioSrc){const a=new Audio(puzzleHintAudioSrc);currentAudioPlaying=a;a.play();a.onended=()=>{currentAudioPlaying=null;};}}
function checkPuzzle(){
    const val=document.getElementById('puzzleInput').value.trim();if(!val){alert('Please type your answer first!');return;}
    puzzleAttemptCount++;
    fetch('/check_word_puzzle',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({answer:val,attempt:puzzleAttemptCount})})
    .then(r=>r.json()).then(data=>{
        puzzleScores.push(data.correct?100:0);puzzleStars+=data.stars;if(data.correct)createConfetti();
        let compHTML='<div style="margin:14px 0;font-size:24px;line-height:2;">';
        data.letter_comparison.forEach(l=>{const cls=l.status==='correct'?'letter-correct':l.status==='incorrect'?'letter-incorrect':'letter-missing';compHTML+=`<span class="letter-highlight ${cls}">${l.letter.toUpperCase()}</span> `;});
        compHTML+='</div>';
        const hintHTML=data.hint?`<div class="hint-box">üí° ${data.hint}</div>`:'';
        const correctWordHTML=!data.correct?`<br><strong>Answer: ${data.correct_word}</strong>`:'';
        document.getElementById('puzzleFeedback').innerHTML=`<div class="feedback">${data.feedback}${correctWordHTML}</div>${compHTML}${hintHTML}`;
        document.getElementById('puzzleSolved').textContent=puzzleScores.filter(s=>s===100).length;
        document.getElementById('puzzleStars').textContent=puzzleStars;
        updatePuzzleAccuracy();
        if(data.correct){
            const xpp=DIFFICULTY_XP[currentPuzzleDifficulty]||1;
            awardXP(xpp,'wordpuzzle',100,data.stars,currentPuzzleDifficulty,puzzleAttemptCount);
            setTimeout(getNewPuzzle,2500);
        } else {if(puzzleAttemptCount>=3){setTimeout(getNewPuzzle,3000);}}
    });
}
function updatePuzzleProgress(){const pct=(currentPuzzleStage/totalStages)*100,pf=document.getElementById('puzzleProgressFill');pf.style.width=pct+'%';pf.textContent=`${currentPuzzleStage}/${totalStages} üß©`;}
function updatePuzzleAccuracy(){if(!puzzleScores.length){document.getElementById('puzzleAccuracy').textContent='0%';return;}document.getElementById('puzzleAccuracy').textContent=Math.round(puzzleScores.reduce((a,b)=>a+b,0)/puzzleScores.length)+'%';}
function showPuzzleCompletionModal(){
    createConfetti();const ms=document.getElementById('modalStars');ms.innerHTML='';
    const solved=puzzleScores.filter(s=>s===100).length;const fsc=Math.min(solved,3);
    for(let i=0;i<3;i++){setTimeout(()=>{const s=document.createElement('span');s.className=i<fsc?'star filled':'star empty';s.textContent='‚≠ê';ms.appendChild(s);},i*300);}
    document.getElementById('modalScore').textContent=`${solved}/${totalStages} Solved`;
    document.getElementById('modalMessage').textContent=solved===totalStages?'üèÜ Puzzle Master! All solved! üèÜ':solved>=3?'üéâ Great puzzle skills! üéâ':'üí™ Keep unscrambling! You can do it!';
    document.getElementById('completionModal').classList.add('active');
}

// ============================================================
//  GRAMMAR
// ============================================================
function resetGrammar(){
    currentGrammarStage=0;grammarCorrectCount=0;grammarStars=0;grammarAnswered=false;
    updateGrammarProgress();
    document.getElementById('grammarQuestionText').textContent='Click "Start Quiz" to begin! üìù';
    document.getElementById('grammarQuestionText').style.color='rgba(255,255,255,.7)';
    document.getElementById('grammarQuestionText').style.fontSize='18px';
    document.getElementById('grammarOptionsGrid').style.display='none';
    document.getElementById('grammarOptionsGrid').innerHTML='';
    document.getElementById('grammarExplanation').style.display='none';
    document.getElementById('grammarStartBtn').style.display='block';
    document.getElementById('grammarAudioBtn').style.display='none';
    document.getElementById('grammarNextBtn').style.display='none';
    document.getElementById('grammarCorrect').textContent='0';
    document.getElementById('grammarTotal').textContent='0';
    document.getElementById('grammarStars').textContent='0';
    document.getElementById('soundWave7').classList.remove('active');
}
function startGrammarQuiz(){
    currentGrammarDifficulty=document.getElementById('grammarDifficultySelect').value;
    currentGrammarStage=0;grammarCorrectCount=0;grammarStars=0;
    document.getElementById('grammarStartBtn').style.display='none';
    loadGrammarQuestion();
}
function loadGrammarQuestion(){
    if(currentGrammarStage>=totalStages){showGrammarCompletionModal();return;}
    currentGrammarStage++;grammarAnswered=false;
    updateGrammarProgress();
    document.getElementById('grammarOptionsGrid').style.display='none';
    document.getElementById('grammarExplanation').style.display='none';
    document.getElementById('grammarNextBtn').style.display='none';
    document.getElementById('grammarQuestionText').textContent='‚è≥ Loading question...';
    document.getElementById('grammarQuestionText').style.color='rgba(255,255,255,.9)';
    document.getElementById('grammarQuestionText').style.fontSize='22px';
    fetch('/grammar_question',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({difficulty:currentGrammarDifficulty})})
    .then(r=>r.json()).then(data=>{
        grammarCurrentAudio=data.audio||'';
        const qText=data.question.replace('___','<span class="grammar-blank">___</span>');
        document.getElementById('grammarQuestionText').innerHTML=qText;
        let optHTML='';
        data.options.forEach((opt,i)=>{optHTML+=`<button class="grammar-option-btn" onclick="selectGrammarOption(${i})">${opt}</button>`;});
        document.getElementById('grammarOptionsGrid').innerHTML=optHTML;
        document.getElementById('grammarOptionsGrid').style.display='grid';
        document.getElementById('grammarAudioBtn').style.display='block';
        if(data.audio){const a=new Audio(data.audio);currentAudioPlaying=a;a.play();a.onended=()=>{currentAudioPlaying=null;};}
        document.getElementById('grammarTotal').textContent=currentGrammarStage;
    });
}
function playGrammarAudio(){if(grammarCurrentAudio){const a=new Audio(grammarCurrentAudio);currentAudioPlaying=a;a.play();a.onended=()=>{currentAudioPlaying=null;};}}
function selectGrammarOption(chosenIndex){
    if(grammarAnswered)return;grammarAnswered=true;
    const btns=document.querySelectorAll('.grammar-option-btn');btns.forEach(b=>b.disabled=true);
    fetch('/check_grammar',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({chosen_index:chosenIndex,difficulty:currentGrammarDifficulty})})
    .then(r=>r.json()).then(data=>{
        btns[chosenIndex].classList.add(data.correct?'correct':'wrong');
        if(!data.correct)btns[data.correct_index].classList.add('correct');
        if(data.correct){grammarCorrectCount++;grammarStars+=data.stars;createConfetti();}
        document.getElementById('grammarCorrect').textContent=grammarCorrectCount;
        document.getElementById('grammarStars').textContent=grammarStars;
        if(data.explanation){
            document.getElementById('grammarExplanationText').textContent=data.explanation;
            document.getElementById('grammarExplanation').style.display='block';
            grammarExplanationAudio=data.explanation_audio||'';
            if(data.explanation_audio){const a=new Audio(data.explanation_audio);currentAudioPlaying=a;setTimeout(()=>a.play(),600);a.onended=()=>{currentAudioPlaying=null;};}
        }
        if(data.correct){const xpp=DIFFICULTY_XP[currentGrammarDifficulty]||1;awardXP(xpp,'grammar',100,data.stars,currentGrammarDifficulty);}
        if(currentGrammarStage>=totalStages){setTimeout(showGrammarCompletionModal,2800);}
        else{document.getElementById('grammarNextBtn').style.display='block';}
    });
}
function nextGrammarQuestion(){loadGrammarQuestion();}
function updateGrammarProgress(){const pct=(currentGrammarStage/totalStages)*100,pf=document.getElementById('grammarProgressFill');pf.style.width=pct+'%';pf.textContent=`${currentGrammarStage}/${totalStages} üìù`;}
function showGrammarCompletionModal(){
    createConfetti();const ms=document.getElementById('modalStars');ms.innerHTML='';
    const fsc=Math.min(Math.floor(grammarCorrectCount/2),3);
    for(let i=0;i<3;i++){setTimeout(()=>{const s=document.createElement('span');s.className=i<fsc?'star filled':'star empty';s.textContent='‚≠ê';ms.appendChild(s);},i*300);}
    document.getElementById('modalScore').textContent=`${grammarCorrectCount}/${totalStages} Correct`;
    document.getElementById('modalMessage').textContent=grammarCorrectCount===totalStages?'üèÜ Grammar Champion! Perfect! üèÜ':grammarCorrectCount>=4?'üéâ Excellent grammar skills! üéâ':grammarCorrectCount>=3?'üëç Good effort! Keep practicing! üëç':'üí™ Keep studying grammar! You\'ll get it!';
    document.getElementById('completionModal').classList.add('active');
}
</script>
</body>
</html>