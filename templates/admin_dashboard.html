<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard ‚Äì GSS English Lab</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --navy: #1a1a2e;
      --blue: #0f3460;
      --accent: #e94560;
      --green: #16a34a;
      --red: #dc2626;
      --yellow: #d97706;
      --sidebar-w: 260px;
    }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f1f5f9; color: #1e293b; display: flex; min-height: 100vh; }

    /* ---- SIDEBAR ---- */
    .sidebar {
      width: var(--sidebar-w);
      background: var(--navy);
      color: white;
      display: flex; flex-direction: column;
      position: fixed; top: 0; left: 0; height: 100vh;
      overflow-y: auto; z-index: 100;
    }
    .sidebar-header {
      padding: 28px 24px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .sidebar-header h2 { font-size: 18px; font-weight: 700; }
    .sidebar-header p  { font-size: 12px; color: #94a3b8; margin-top: 4px; }
    .badge-admin {
      display: inline-block;
      background: var(--accent);
      font-size: 10px;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 20px;
      margin-top: 6px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    .nav { padding: 16px 12px; flex: 1; }
    .nav-section { font-size: 10px; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.1em; padding: 12px 12px 4px; }
    .nav-item {
      display: flex; align-items: center; gap: 12px;
      padding: 11px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.15s;
      color: #cbd5e1;
      margin-bottom: 2px;
    }
    .nav-item:hover { background: rgba(255,255,255,0.08); color: white; }
    .nav-item.active { background: rgba(255,255,255,0.15); color: white; font-weight: 600; }
    .nav-item .icon { font-size: 18px; width: 24px; text-align: center; }
    .pending-badge {
      margin-left: auto;
      background: var(--accent);
      color: white;
      font-size: 11px;
      font-weight: 700;
      padding: 1px 7px;
      border-radius: 20px;
      min-width: 20px;
      text-align: center;
    }
    .sidebar-footer {
      padding: 16px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    .logout-btn {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 14px;
      border-radius: 8px;
      color: #f87171;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.15s;
      text-decoration: none;
    }
    .logout-btn:hover { background: rgba(239,68,68,0.15); }

    /* ---- MAIN ---- */
    .main { margin-left: var(--sidebar-w); flex: 1; display: flex; flex-direction: column; min-height: 100vh; }
    .topbar {
      background: white;
      border-bottom: 1px solid #e2e8f0;
      padding: 16px 32px;
      display: flex; align-items: center; justify-content: space-between;
      position: sticky; top: 0; z-index: 50;
    }
    .topbar h1 { font-size: 20px; font-weight: 700; color: var(--navy); }
    .topbar-time { font-size: 13px; color: #64748b; }
    .content { padding: 32px; flex: 1; }

    /* ---- SECTIONS ---- */
    .section { display: none; }
    .section.active { display: block; }

    /* ---- STAT CARDS ---- */
    .stat-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }
    .stat-card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      border-left: 4px solid transparent;
    }
    .stat-card.blue   { border-color: #3b82f6; }
    .stat-card.green  { border-color: var(--green); }
    .stat-card.yellow { border-color: var(--yellow); }
    .stat-card.red    { border-color: var(--red); }
    .stat-card.purple { border-color: #7c3aed; }
    .stat-label { font-size: 12px; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px; }
    .stat-value { font-size: 32px; font-weight: 800; color: var(--navy); }
    .stat-sub   { font-size: 12px; color: #94a3b8; margin-top: 4px; }

    /* ---- TABLES ---- */
    .panel {
      background: white;
      border-radius: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      overflow: hidden;
      margin-bottom: 28px;
    }
    .panel-header {
      padding: 20px 24px;
      border-bottom: 1px solid #f1f5f9;
      display: flex; align-items: center; justify-content: space-between;
    }
    .panel-header h2 { font-size: 16px; font-weight: 700; color: var(--navy); }
    .panel-header .actions { display: flex; gap: 10px; align-items: center; }
    table { width: 100%; border-collapse: collapse; }
    thead th {
      background: #f8fafc;
      padding: 12px 20px;
      text-align: left;
      font-size: 12px;
      font-weight: 700;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    tbody tr { border-top: 1px solid #f1f5f9; transition: background 0.1s; }
    tbody tr:hover { background: #f8fafc; }
    tbody td { padding: 14px 20px; font-size: 14px; color: #374151; }

    /* ---- BADGES / STATUS ---- */
    .chip {
      display: inline-flex; align-items: center; gap: 4px;
      font-size: 11px; font-weight: 700;
      padding: 3px 10px; border-radius: 20px;
    }
    .chip.green  { background: #dcfce7; color: #16a34a; }
    .chip.yellow { background: #fef3c7; color: #d97706; }
    .chip.red    { background: #fee2e2; color: #dc2626; }
    .chip.gray   { background: #f1f5f9; color: #64748b; }
    .chip.blue   { background: #dbeafe; color: #1d4ed8; }

    /* ---- BUTTONS ---- */
    .btn {
      padding: 7px 14px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: opacity 0.15s;
      display: inline-flex; align-items: center; gap: 5px;
    }
    .btn:hover { opacity: 0.85; }
    .btn-sm { padding: 5px 10px; font-size: 12px; }
    .btn-primary { background: var(--navy); color: white; }
    .btn-green   { background: var(--green); color: white; }
    .btn-red     { background: var(--red); color: white; }
    .btn-yellow  { background: var(--yellow); color: white; }
    .btn-outline { background: transparent; border: 1px solid #e2e8f0; color: #374151; }
    .btn-outline:hover { background: #f8fafc; opacity: 1; }

    /* ---- SEARCH / FILTER ---- */
    .search-bar {
      padding: 8px 14px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      width: 220px;
      transition: border-color 0.2s;
    }
    .search-bar:focus { border-color: var(--blue); }
    select.filter-sel {
      padding: 8px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 13px;
      outline: none;
      background: white;
      cursor: pointer;
    }

    /* ---- MODAL ---- */
    .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 200; align-items: center; justify-content: center; }
    .overlay.open { display: flex; }
    .modal {
      background: white;
      border-radius: 18px;
      padding: 32px;
      width: 100%;
      max-width: 460px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.25);
    }
    .modal h3 { font-size: 18px; font-weight: 700; color: var(--navy); margin-bottom: 18px; }
    .modal label { display: block; font-size: 13px; font-weight: 600; color: #374151; margin-bottom: 6px; }
    .modal input, .modal textarea {
      width: 100%;
      padding: 10px 14px;
      border: 1.5px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      margin-bottom: 16px;
      font-family: inherit;
    }
    .modal input:focus, .modal textarea:focus { border-color: var(--blue); }
    .modal-footer { display: flex; gap: 12px; justify-content: flex-end; margin-top: 8px; }
    .modal-msg { font-size: 13px; padding: 10px; border-radius: 8px; margin-bottom: 14px; display: none; }
    .modal-msg.success { background: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0; }
    .modal-msg.error   { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }

    /* ---- AUDIT LOG ---- */
    .log-entry {
      padding: 14px 20px;
      border-bottom: 1px solid #f1f5f9;
      display: flex; align-items: flex-start; gap: 14px;
    }
    .log-entry:last-child { border-bottom: none; }
    .log-icon { font-size: 20px; flex-shrink: 0; margin-top: 2px; }
    .log-action { font-size: 13px; font-weight: 700; color: var(--navy); }
    .log-detail { font-size: 12px; color: #64748b; margin-top: 2px; }
    .log-time   { font-size: 11px; color: #94a3b8; margin-top: 4px; }

    /* ---- TOP STUDENTS TABLE ---- */
    .rank-num { font-weight: 800; color: var(--navy); font-size: 16px; }
    .rank-num.gold   { color: #d97706; }
    .rank-num.silver { color: #9ca3af; }
    .rank-num.bronze { color: #b45309; }

    /* ---- TOAST ---- */
    .toast {
      position: fixed; bottom: 24px; right: 24px;
      background: #1e293b; color: white;
      padding: 14px 20px;
      border-radius: 12px;
      font-size: 14px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
      z-index: 999;
      transform: translateY(80px); opacity: 0;
      transition: all 0.3s;
      max-width: 340px;
    }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.success { border-left: 4px solid #16a34a; }
    .toast.error   { border-left: 4px solid #dc2626; }

    /* ---- LOADING ---- */
    .spinner { display: inline-block; width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.6s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ---- CHECKBOX ---- */
    input[type="checkbox"] { width: 16px; height: 16px; cursor: pointer; accent-color: var(--navy); }

    /* ---- EMPTY STATE ---- */
    .empty { text-align: center; padding: 60px 20px; color: #94a3b8; }
    .empty-icon { font-size: 48px; margin-bottom: 12px; }
    .empty p { font-size: 15px; }
  </style>
</head>
<body>

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-header">
    <h2>üõ°Ô∏è Admin Panel</h2>
    <p>GSS English Learning Lab</p>
    <span class="badge-admin">Administrator</span>
  </div>
  <nav class="nav">
    <div class="nav-section">Overview</div>
    <div class="nav-item active" onclick="showSection('overview')">
      <span class="icon">üìä</span> Dashboard
    </div>

    <div class="nav-section">Management</div>
    <div class="nav-item" onclick="showSection('teachers')">
      <span class="icon">üë©‚Äçüè´</span> Teachers
      <span class="pending-badge" id="pendingCount" style="display:none">0</span>
    </div>
    <div class="nav-item" onclick="showSection('students')">
      <span class="icon">üë®‚Äçüéì</span> Students
    </div>

    <div class="nav-section">System</div>
    <div class="nav-item" onclick="showSection('audit')">
      <span class="icon">üìã</span> Audit Log
    </div>
    <div class="nav-item" onclick="showSection('settings')">
      <span class="icon">‚öôÔ∏è</span> Settings
    </div>
  </nav>
  <div class="sidebar-footer">
    <a class="logout-btn" href="/admin/logout">üö™ Logout</a>
  </div>
</aside>

<!-- MAIN AREA -->
<div class="main">
  <div class="topbar">
    <h1 id="sectionTitle">Dashboard Overview</h1>
    <div class="topbar-time" id="clock"></div>
  </div>

  <div class="content">

    <!-- ===== OVERVIEW SECTION ===== -->
    <div class="section active" id="overview">
      <div class="stat-grid" id="statGrid">
        <div class="stat-card blue">
          <div class="stat-label">Total Students</div>
          <div class="stat-value" id="st-students">‚Äì</div>
          <div class="stat-sub" id="st-active-students">Loading‚Ä¶</div>
        </div>
        <div class="stat-card green">
          <div class="stat-label">Total Teachers</div>
          <div class="stat-value" id="st-teachers">‚Äì</div>
          <div class="stat-sub" id="st-pending-teachers">Loading‚Ä¶</div>
        </div>
        <div class="stat-card yellow">
          <div class="stat-label">Total XP Earned</div>
          <div class="stat-value" id="st-xp">‚Äì</div>
          <div class="stat-sub">Across all students</div>
        </div>
        <div class="stat-card purple">
          <div class="stat-label">Login Sessions</div>
          <div class="stat-value" id="st-sessions">‚Äì</div>
          <div class="stat-sub">All-time total</div>
        </div>
        <div class="stat-card red">
          <div class="stat-label">Today's Activity</div>
          <div class="stat-value" id="st-today">‚Äì</div>
          <div class="stat-sub">Actions logged today</div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <h2>üèÜ Top 5 Students</h2>
        </div>
        <table>
          <thead><tr>
            <th>Rank</th><th>Student</th><th>Class</th><th>XP</th><th>Stars</th><th>Streak</th>
          </tr></thead>
          <tbody id="topStudentsBody">
            <tr><td colspan="6" style="text-align:center;padding:30px;color:#94a3b8">Loading‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ===== TEACHERS SECTION ===== -->
    <div class="section" id="teachers">
      <div class="panel">
        <div class="panel-header">
          <h2>üë©‚Äçüè´ Teacher Management</h2>
          <div class="actions">
            <input class="search-bar" id="teacherSearch" placeholder="üîç Search teachers‚Ä¶" oninput="filterTeachers()"/>
            <select class="filter-sel" id="teacherFilter" onchange="filterTeachers()">
              <option value="all">All Teachers</option>
              <option value="pending">Pending Approval</option>
              <option value="approved">Approved</option>
              <option value="inactive">Deactivated</option>
            </select>
          </div>
        </div>
        <table>
          <thead><tr>
            <th>Name</th><th>Email</th><th>Status</th><th>Approval</th><th>Joined</th><th>Actions</th>
          </tr></thead>
          <tbody id="teacherTableBody">
            <tr><td colspan="6" style="text-align:center;padding:30px;color:#94a3b8">Loading‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ===== STUDENTS SECTION ===== -->
    <div class="section" id="students">
      <div class="panel">
        <div class="panel-header">
          <h2>üë®‚Äçüéì Student Management</h2>
          <div class="actions">
            <input class="search-bar" id="studentSearch" placeholder="üîç Search students‚Ä¶" oninput="filterStudents()"/>
            <select class="filter-sel" id="studentClassFilter" onchange="filterStudents()">
              <option value="all">All Classes</option>
              <option value="1">Class 1</option><option value="2">Class 2</option>
              <option value="3">Class 3</option><option value="4">Class 4</option>
              <option value="5">Class 5</option><option value="6">Class 6</option>
              <option value="7">Class 7</option><option value="8">Class 8</option>
              <option value="9">Class 9</option><option value="10">Class 10</option>
            </select>
            <select class="filter-sel" id="studentStatusFilter" onchange="filterStudents()">
              <option value="all">All Status</option>
              <option value="active">Active</option>
              <option value="inactive">Deactivated</option>
            </select>
            <button class="btn btn-outline btn-sm" onclick="openBulkModal()">‚ö° Bulk Action</button>
          </div>
        </div>
        <table>
          <thead><tr>
            <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)"/></th>
            <th>Name</th><th>Roll No.</th><th>User ID</th><th>Class</th>
            <th>XP</th><th>Stars</th><th>Status</th><th>Actions</th>
          </tr></thead>
          <tbody id="studentTableBody">
            <tr><td colspan="9" style="text-align:center;padding:30px;color:#94a3b8">Loading‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ===== AUDIT LOG SECTION ===== -->
    <div class="section" id="audit">
      <div class="panel">
        <div class="panel-header">
          <h2>üìã Admin Audit Log</h2>
          <button class="btn btn-outline btn-sm" onclick="loadAuditLog()">üîÑ Refresh</button>
        </div>
        <div id="auditLogContainer">
          <div class="empty"><div class="empty-icon">‚è≥</div><p>Loading audit log‚Ä¶</p></div>
        </div>
      </div>
    </div>

    <!-- ===== SETTINGS SECTION ===== -->
    <div class="section" id="settings">
      <div class="panel">
        <div class="panel-header"><h2>‚öôÔ∏è Admin Settings</h2></div>
        <div style="padding: 32px;">
          <h3 style="font-size:15px;font-weight:700;color:var(--navy);margin-bottom:8px;">Change Admin Password</h3>
          <p style="font-size:13px;color:#64748b;margin-bottom:20px;">
            After submitting, update the <code>ADMIN_PASSWORD</code> value in your <code>.env</code> file and restart the server for the change to take effect.
          </p>
          <div style="max-width:360px;">
            <label>Current Password</label>
            <input type="password" id="oldPass" placeholder="Current admin password" style="width:100%;padding:10px 14px;border:1.5px solid #e2e8f0;border-radius:8px;font-size:14px;outline:none;margin-bottom:14px;"/>
            <label>New Password</label>
            <input type="password" id="newPass" placeholder="New password (min 8 chars)" style="width:100%;padding:10px 14px;border:1.5px solid #e2e8f0;border-radius:8px;font-size:14px;outline:none;margin-bottom:14px;"/>
            <button class="btn btn-primary" onclick="changeAdminPassword()">üîí Change Password</button>
            <div id="passMsg" style="margin-top:14px;font-size:13px;display:none;"></div>
          </div>
          <hr style="margin:32px 0;border:none;border-top:1px solid #e2e8f0;"/>
          <h3 style="font-size:15px;font-weight:700;color:var(--navy);margin-bottom:8px;">System Information</h3>
          <div style="background:#f8fafc;border-radius:10px;padding:20px;font-size:13px;color:#374151;line-height:2;">
            <strong>Admin Username:</strong> Set via <code>ADMIN_USERNAME</code> env var<br/>
            <strong>Password:</strong> Set via <code>ADMIN_PASSWORD</code> env var<br/>
            <strong>DB:</strong> SQLite (students.db)<br/>
            <strong>Teacher Login:</strong> Requires admin approval ‚úÖ<br/>
            <strong>Audit Log:</strong> All admin actions logged ‚úÖ
          </div>
        </div>
      </div>
    </div>

  </div><!-- /content -->
</div><!-- /main -->

<!-- ===== MODALS ===== -->

<!-- Teacher Action Modal -->
<div class="overlay" id="teacherModal">
  <div class="modal">
    <h3 id="teacherModalTitle">Teacher Action</h3>
    <div class="modal-msg" id="teacherModalMsg"></div>
    <div id="teacherModalBody"></div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('teacherModal')">Cancel</button>
      <button class="btn btn-primary" id="teacherModalConfirm" onclick="confirmTeacherAction()">Confirm</button>
    </div>
  </div>
</div>

<!-- Student Action Modal -->
<div class="overlay" id="studentModal">
  <div class="modal">
    <h3 id="studentModalTitle">Student Action</h3>
    <div class="modal-msg" id="studentModalMsg"></div>
    <div id="studentModalBody"></div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('studentModal')">Cancel</button>
      <button class="btn btn-primary" id="studentModalConfirm" onclick="confirmStudentAction()">Confirm</button>
    </div>
  </div>
</div>

<!-- Bulk Action Modal -->
<div class="overlay" id="bulkModal">
  <div class="modal">
    <h3>‚ö° Bulk Student Action</h3>
    <div class="modal-msg" id="bulkModalMsg"></div>
    <label>Select Action</label>
    <select id="bulkActionSel" style="width:100%;padding:10px 14px;border:1.5px solid #e2e8f0;border-radius:8px;font-size:14px;outline:none;margin-bottom:16px;">
      <option value="activate">Activate Selected</option>
      <option value="deactivate">Deactivate Selected</option>
      <option value="delete">Delete Selected (‚ö†Ô∏è Permanent)</option>
    </select>
    <p id="bulkCount" style="font-size:13px;color:#64748b;margin-bottom:8px;"></p>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('bulkModal')">Cancel</button>
      <button class="btn btn-red" onclick="confirmBulkAction()">Apply Action</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
/* ===================== STATE ===================== */
let allTeachers  = [];
let allStudents  = [];
let currentTeacherAction = null;
let currentStudentAction = null;
let currentTeacherId     = null;
let currentStudentId     = null;

/* ===================== INIT ===================== */
document.addEventListener('DOMContentLoaded', () => {
  updateClock();
  setInterval(updateClock, 60000);
  loadStats();
  loadTeachers();
  loadStudents();
});

function updateClock() {
  const now = new Date();
  document.getElementById('clock').textContent =
    now.toLocaleDateString('en-IN', { weekday:'short', day:'numeric', month:'short' }) +
    '  ' + now.toLocaleTimeString('en-IN', { hour:'2-digit', minute:'2-digit' });
}

/* ===================== NAVIGATION ===================== */
const SECTION_TITLES = {
  overview: 'Dashboard Overview',
  teachers: 'Teacher Management',
  students: 'Student Management',
  audit:    'Admin Audit Log',
  settings: 'Settings',
};

function showSection(name) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
  document.getElementById(name).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(i => {
    if (i.textContent.toLowerCase().includes(SECTION_TITLES[name]?.split(' ')[0].toLowerCase() || name)) {
      i.classList.add('active');
    }
  });
  // crude active item match
  document.querySelectorAll('.nav-item').forEach(i => {
    if (i.getAttribute('onclick') && i.getAttribute('onclick').includes(`'${name}'`)) {
      i.classList.add('active');
    }
  });
  document.getElementById('sectionTitle').textContent = SECTION_TITLES[name] || name;
  if (name === 'audit') loadAuditLog();
}

/* ===================== STATS ===================== */
async function loadStats() {
  const data = await api('/admin/stats');
  if (!data.success) return;
  const s = data.stats;
  document.getElementById('st-students').textContent = s.totalStudents;
  document.getElementById('st-active-students').textContent = `${s.activeStudents} active ¬∑ ${s.inactiveStudents} inactive`;
  document.getElementById('st-teachers').textContent = s.totalTeachers;
  document.getElementById('st-pending-teachers').textContent = s.pendingTeachers + ' pending approval';
  document.getElementById('st-xp').textContent = s.totalXP.toLocaleString();
  document.getElementById('st-sessions').textContent = s.totalSessions.toLocaleString();
  document.getElementById('st-today').textContent = s.activityToday;
  if (s.pendingTeachers > 0) {
    const pb = document.getElementById('pendingCount');
    pb.textContent = s.pendingTeachers;
    pb.style.display = 'inline-block';
  }
  // Top students
  const tbody = document.getElementById('topStudentsBody');
  if (s.topStudents.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:30px;color:#94a3b8">No students yet</td></tr>';
    return;
  }
  tbody.innerHTML = s.topStudents.map((st, i) => {
    const rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
    const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : (i+1);
    return `<tr>
      <td><span class="rank-num ${rankClass}">${medal}</span></td>
      <td><strong>${st.name}</strong></td>
      <td>${st.class}</td>
      <td><strong>${st.xp}</strong> XP</td>
      <td>‚≠ê ${st.stars}</td>
      <td>üî• ${st.streak} days</td>
    </tr>`;
  }).join('');
}

/* ===================== TEACHERS ===================== */
async function loadTeachers() {
  const data = await api('/admin/teachers');
  if (!data.success) return;
  allTeachers = data.teachers;
  renderTeachers(allTeachers);
}

function renderTeachers(list) {
  const tbody = document.getElementById('teacherTableBody');
  if (list.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6"><div class="empty"><div class="empty-icon">üë©‚Äçüè´</div><p>No teachers found</p></div></td></tr>';
    return;
  }
  tbody.innerHTML = list.map(t => {
    const statusChip = t.isActive
      ? '<span class="chip green">‚óè Active</span>'
      : '<span class="chip gray">‚óè Inactive</span>';
    const approvalChip = t.isApproved
      ? '<span class="chip green">‚úÖ Approved</span>'
      : '<span class="chip yellow">‚è≥ Pending</span>';
    const joined = t.createdAt ? new Date(t.createdAt).toLocaleDateString('en-IN') : 'N/A';
    const pendingBtns = !t.isApproved ? `
      <button class="btn btn-green btn-sm" onclick="openTeacherModal('approve', ${t.id}, '${escHtml(t.name)}')">‚úÖ Approve</button>
      <button class="btn btn-red btn-sm" onclick="openTeacherModal('reject', ${t.id}, '${escHtml(t.name)}')">‚ùå Reject</button>
    ` : '';
    return `<tr>
      <td><strong>${escHtml(t.name)}</strong></td>
      <td><span style="color:#64748b">${escHtml(t.email)}</span></td>
      <td>${statusChip}</td>
      <td>${approvalChip}</td>
      <td>${joined}</td>
      <td style="display:flex;gap:6px;flex-wrap:wrap;align-items:center;">
        ${pendingBtns}
        <button class="btn btn-yellow btn-sm" onclick="openTeacherModal('toggle', ${t.id}, '${escHtml(t.name)}')">${t.isActive ? 'üîá Deactivate' : '‚úÖ Activate'}</button>
        <button class="btn btn-outline btn-sm" onclick="openTeacherModal('password', ${t.id}, '${escHtml(t.name)}')">üîë Password</button>
        <button class="btn btn-red btn-sm" onclick="openTeacherModal('delete', ${t.id}, '${escHtml(t.name)}')">üóëÔ∏è Delete</button>
      </td>
    </tr>`;
  }).join('');
}

function filterTeachers() {
  const q      = document.getElementById('teacherSearch').value.toLowerCase();
  const filter = document.getElementById('teacherFilter').value;
  let list = allTeachers.filter(t => {
    const matchQ = t.name.toLowerCase().includes(q) || t.email.toLowerCase().includes(q);
    const matchF = filter === 'all' ? true
      : filter === 'pending'  ? !t.isApproved
      : filter === 'approved' ? t.isApproved && t.isActive
      : filter === 'inactive' ? !t.isActive
      : true;
    return matchQ && matchF;
  });
  renderTeachers(list);
}

function openTeacherModal(action, id, name) {
  currentTeacherAction = action;
  currentTeacherId     = id;
  const modal  = document.getElementById('teacherModal');
  const title  = document.getElementById('teacherModalTitle');
  const body   = document.getElementById('teacherModalBody');
  const msgEl  = document.getElementById('teacherModalMsg');
  const btn    = document.getElementById('teacherModalConfirm');
  msgEl.style.display = 'none';

  if (action === 'approve') {
    title.textContent = '‚úÖ Approve Teacher';
    body.innerHTML = `<p style="font-size:14px;margin-bottom:14px;">Approve <strong>${name}</strong> as a teacher? They will be able to login immediately.</p>
      <label>Note (optional)</label>
      <textarea id="approvalNote" rows="3" placeholder="e.g. Verified credentials"></textarea>`;
    btn.className = 'btn btn-green'; btn.textContent = 'Approve';
  } else if (action === 'reject') {
    title.textContent = '‚ùå Reject Teacher';
    body.innerHTML = `<p style="font-size:14px;margin-bottom:14px;">Reject <strong>${name}</strong>'s application?</p>
      <label>Reason</label>
      <textarea id="approvalNote" rows="3" placeholder="Reason for rejection‚Ä¶"></textarea>`;
    btn.className = 'btn btn-red'; btn.textContent = 'Reject';
  } else if (action === 'toggle') {
    const teacher = allTeachers.find(t => t.id === id);
    const verb    = teacher?.isActive ? 'Deactivate' : 'Activate';
    title.textContent = `${verb} Teacher`;
    body.innerHTML = `<p style="font-size:14px;">Are you sure you want to <strong>${verb.toLowerCase()}</strong> <strong>${name}</strong>?</p>`;
    btn.className = teacher?.isActive ? 'btn btn-yellow' : 'btn btn-green';
    btn.textContent = verb;
  } else if (action === 'password') {
    title.textContent = 'üîë Reset Teacher Password';
    body.innerHTML = `<p style="font-size:14px;margin-bottom:14px;">Set a new password for <strong>${name}</strong>.</p>
      <label>New Password</label>
      <input type="password" id="newTeacherPass" placeholder="Min 6 characters"/>`;
    btn.className = 'btn btn-primary'; btn.textContent = 'Reset Password';
  } else if (action === 'delete') {
    title.textContent = 'üóëÔ∏è Delete Teacher';
    body.innerHTML = `<p style="font-size:14px;color:#dc2626;"><strong>‚ö†Ô∏è This is permanent.</strong> Delete teacher <strong>${name}</strong>? This cannot be undone.</p>`;
    btn.className = 'btn btn-red'; btn.textContent = 'Delete Permanently';
  }
  modal.classList.add('open');
}

async function confirmTeacherAction() {
  const action = currentTeacherAction;
  const id     = currentTeacherId;
  const msgEl  = document.getElementById('teacherModalMsg');
  let endpoint, body;

  if (action === 'approve') {
    endpoint = '/admin/teachers/approve';
    const note = document.getElementById('approvalNote')?.value || '';
    body = { teacherId: id, note };
  } else if (action === 'reject') {
    endpoint = '/admin/teachers/reject';
    const note = document.getElementById('approvalNote')?.value || '';
    body = { teacherId: id, note };
  } else if (action === 'toggle') {
    endpoint = '/admin/teachers/toggle_active';
    body = { teacherId: id };
  } else if (action === 'password') {
    const pass = document.getElementById('newTeacherPass')?.value || '';
    if (pass.length < 6) { showModalMsg('teacherModalMsg', 'Password must be at least 6 characters.', 'error'); return; }
    endpoint = '/admin/teachers/reset_password';
    body = { teacherId: id, newPassword: pass };
  } else if (action === 'delete') {
    endpoint = '/admin/teachers/delete';
    body = { teacherId: id };
  }

  const data = await api(endpoint, 'POST', body);
  if (data.success) {
    closeModal('teacherModal');
    showToast(data.message, 'success');
    await loadTeachers();
    await loadStats();
  } else {
    showModalMsg('teacherModalMsg', data.message || 'Action failed.', 'error');
  }
}

/* ===================== STUDENTS ===================== */
async function loadStudents() {
  const data = await api('/admin/students');
  if (!data.success) return;
  allStudents = data.students;
  renderStudents(allStudents);
}

function renderStudents(list) {
  const tbody = document.getElementById('studentTableBody');
  if (list.length === 0) {
    tbody.innerHTML = '<tr><td colspan="9"><div class="empty"><div class="empty-icon">üë®‚Äçüéì</div><p>No students found</p></div></td></tr>';
    return;
  }
  tbody.innerHTML = list.map(s => {
    const statusChip = s.isActive
      ? '<span class="chip green">‚óè Active</span>'
      : '<span class="chip red">‚óè Inactive</span>';
    return `<tr data-id="${s.id}" data-class="${s.className}" data-status="${s.isActive ? 'active' : 'inactive'}">
      <td><input type="checkbox" class="student-cb" value="${s.id}"/></td>
      <td><strong>${escHtml(s.name)}</strong></td>
      <td>${s.rollNo}</td>
      <td><code style="font-size:12px;background:#f1f5f9;padding:2px 6px;border-radius:4px;">${s.userIdCode}</code></td>
      <td>${s.classLabel}</td>
      <td><strong>${s.xp}</strong> XP</td>
      <td>‚≠ê ${s.totalStars}</td>
      <td>${statusChip}</td>
      <td style="display:flex;gap:5px;flex-wrap:wrap;">
        <button class="btn btn-yellow btn-sm" onclick="openStudentModal('toggle', ${s.id}, '${escHtml(s.name)}')">${s.isActive ? 'üîá' : '‚úÖ'}</button>
        <button class="btn btn-outline btn-sm" onclick="openStudentModal('password', ${s.id}, '${escHtml(s.name)}')">üîë</button>
        <button class="btn btn-outline btn-sm" onclick="openStudentModal('reset', ${s.id}, '${escHtml(s.name)}')">üîÑ</button>
        <button class="btn btn-red btn-sm" onclick="openStudentModal('delete', ${s.id}, '${escHtml(s.name)}')">üóëÔ∏è</button>
      </td>
    </tr>`;
  }).join('');
}

function filterStudents() {
  const q       = document.getElementById('studentSearch').value.toLowerCase();
  const cls     = document.getElementById('studentClassFilter').value;
  const status  = document.getElementById('studentStatusFilter').value;
  let list = allStudents.filter(s => {
    const matchQ  = s.name.toLowerCase().includes(q) || s.rollNo.includes(q) || s.userIdCode.toLowerCase().includes(q);
    const matchC  = cls    === 'all' ? true : s.className === cls;
    const matchS  = status === 'all' ? true : (status === 'active' ? s.isActive : !s.isActive);
    return matchQ && matchC && matchS;
  });
  renderStudents(list);
}

function toggleSelectAll(cb) {
  document.querySelectorAll('.student-cb').forEach(c => c.checked = cb.checked);
}

function getSelectedStudentIds() {
  return [...document.querySelectorAll('.student-cb:checked')].map(c => parseInt(c.value));
}

function openBulkModal() {
  const ids = getSelectedStudentIds();
  if (ids.length === 0) { showToast('Please select at least one student.', 'error'); return; }
  document.getElementById('bulkCount').textContent = `${ids.length} student(s) selected.`;
  document.getElementById('bulkModalMsg').style.display = 'none';
  document.getElementById('bulkModal').classList.add('open');
}

async function confirmBulkAction() {
  const action     = document.getElementById('bulkActionSel').value;
  const studentIds = getSelectedStudentIds();
  const data = await api('/admin/students/bulk_action', 'POST', { action, studentIds });
  if (data.success) {
    closeModal('bulkModal');
    showToast(data.message, 'success');
    await loadStudents();
    await loadStats();
    document.getElementById('selectAll').checked = false;
  } else {
    showModalMsg('bulkModalMsg', data.message, 'error');
  }
}

function openStudentModal(action, id, name) {
  currentStudentAction = action;
  currentStudentId     = id;
  const modal = document.getElementById('studentModal');
  const title = document.getElementById('studentModalTitle');
  const body  = document.getElementById('studentModalBody');
  const btn   = document.getElementById('studentModalConfirm');
  document.getElementById('studentModalMsg').style.display = 'none';

  if (action === 'toggle') {
    const st   = allStudents.find(s => s.id === id);
    const verb = st?.isActive ? 'Deactivate' : 'Activate';
    title.textContent = `${verb} Student`;
    body.innerHTML = `<p style="font-size:14px;">Are you sure you want to <strong>${verb.toLowerCase()}</strong> <strong>${name}</strong>?</p>`;
    btn.className   = st?.isActive ? 'btn btn-yellow' : 'btn btn-green';
    btn.textContent = verb;
  } else if (action === 'password') {
    title.textContent = 'üîë Reset Student Password';
    body.innerHTML = `<p style="font-size:14px;margin-bottom:14px;">Set new password for <strong>${name}</strong>.</p>
      <label>New Password</label>
      <input type="password" id="newStudentPass" placeholder="Min 4 characters"/>`;
    btn.className = 'btn btn-primary'; btn.textContent = 'Reset Password';
  } else if (action === 'reset') {
    title.textContent = 'üîÑ Reset Student Progress';
    body.innerHTML = `<p style="font-size:14px;color:#dc2626;">‚ö†Ô∏è This will <strong>permanently erase all XP, stars, badges, and activity logs</strong> for <strong>${name}</strong>. This cannot be undone!</p>`;
    btn.className = 'btn btn-red'; btn.textContent = 'Reset All Progress';
  } else if (action === 'delete') {
    title.textContent = 'üóëÔ∏è Delete Student';
    body.innerHTML = `<p style="font-size:14px;color:#dc2626;">‚ö†Ô∏è <strong>Permanently delete</strong> student <strong>${name}</strong> and all their data? This cannot be undone!</p>`;
    btn.className = 'btn btn-red'; btn.textContent = 'Delete Permanently';
  }
  modal.classList.add('open');
}

async function confirmStudentAction() {
  const action = currentStudentAction;
  const id     = currentStudentId;
  let endpoint, body;

  if (action === 'toggle') {
    endpoint = '/admin/students/toggle_active';
    body = { studentId: id };
  } else if (action === 'password') {
    const pass = document.getElementById('newStudentPass')?.value || '';
    if (pass.length < 4) { showModalMsg('studentModalMsg', 'Password must be at least 4 characters.', 'error'); return; }
    endpoint = '/admin/students/reset_password';
    body = { studentId: id, newPassword: pass };
  } else if (action === 'reset') {
    endpoint = '/admin/students/reset_progress';
    body = { studentId: id };
  } else if (action === 'delete') {
    endpoint = '/admin/students/delete';
    body = { studentId: id };
  }

  const data = await api(endpoint, 'POST', body);
  if (data.success) {
    closeModal('studentModal');
    showToast(data.message, 'success');
    await loadStudents();
    await loadStats();
  } else {
    showModalMsg('studentModalMsg', data.message || 'Action failed.', 'error');
  }
}

/* ===================== AUDIT LOG ===================== */
async function loadAuditLog() {
  const data = await api('/admin/audit_log?limit=100');
  const container = document.getElementById('auditLogContainer');
  if (!data.success || !data.log.length) {
    container.innerHTML = '<div class="empty"><div class="empty-icon">üìã</div><p>No actions logged yet.</p></div>';
    return;
  }
  const ACTION_ICONS = {
    'ADMIN_LOGIN': 'üîê', 'ADMIN_LOGOUT': 'üö™',
    'APPROVE_TEACHER': '‚úÖ', 'REJECT_TEACHER': '‚ùå',
    'ACTIVATE_TEACHER': '‚úÖ', 'DEACTIVATE_TEACHER': 'üîá',
    'DELETE_TEACHER': 'üóëÔ∏è', 'RESET_TEACHER_PASSWORD': 'üîë',
    'ACTIVATE_STUDENT': '‚úÖ', 'DEACTIVATE_STUDENT': 'üîá',
    'DELETE_STUDENT': 'üóëÔ∏è', 'RESET_STUDENT_PASSWORD': 'üîë',
    'RESET_STUDENT_PROGRESS': 'üîÑ',
    'BULK_ACTIVATE_STUDENT': '‚úÖ', 'BULK_DEACTIVATE_STUDENT': 'üîá', 'BULK_DELETE_STUDENT': 'üóëÔ∏è',
    'CHANGE_ADMIN_PASSWORD': 'üîí',
  };
  container.innerHTML = data.log.map(entry => {
    const icon = ACTION_ICONS[entry.action] || 'üìù';
    const ts   = entry.timestamp ? new Date(entry.timestamp).toLocaleString('en-IN') : '';
    const detail = [entry.targetName ? `Target: ${entry.targetName}` : '', entry.details || ''].filter(Boolean).join(' ¬∑ ');
    return `<div class="log-entry">
      <div class="log-icon">${icon}</div>
      <div>
        <div class="log-action">${entry.action}</div>
        ${detail ? `<div class="log-detail">${escHtml(detail)}</div>` : ''}
        <div class="log-time">By ${entry.adminUsername} ¬∑ ${ts}</div>
      </div>
    </div>`;
  }).join('');
}

/* ===================== SETTINGS ===================== */
async function changeAdminPassword() {
  const oldPass = document.getElementById('oldPass').value;
  const newPass = document.getElementById('newPass').value;
  const msgEl   = document.getElementById('passMsg');
  if (!oldPass || !newPass) { showPassMsg('Both fields are required.', 'error'); return; }
  if (newPass.length < 8) { showPassMsg('New password must be at least 8 characters.', 'error'); return; }
  const data = await api('/admin/change_password', 'POST', { oldPassword: oldPass, newPassword: newPass });
  showPassMsg(data.message, data.success ? 'success' : 'error');
}
function showPassMsg(txt, type) {
  const el = document.getElementById('passMsg');
  el.textContent = txt;
  el.style.cssText = type === 'success'
    ? 'display:block;color:#16a34a;background:#f0fdf4;padding:10px;border-radius:8px;border:1px solid #bbf7d0;font-size:13px;'
    : 'display:block;color:#dc2626;background:#fef2f2;padding:10px;border-radius:8px;border:1px solid #fecaca;font-size:13px;';
}

/* ===================== HELPERS ===================== */
async function api(url, method = 'GET', body = null) {
  try {
    const opts = { method, headers: { 'Content-Type': 'application/json' } };
    if (body) opts.body = JSON.stringify(body);
    const res  = await fetch(url, opts);
    if (res.redirected) { window.location.href = '/admin/login'; return { success: false }; }
    return await res.json();
  } catch { return { success: false, message: 'Network error' }; }
}

function closeModal(id) {
  document.getElementById(id).classList.remove('open');
}

function showModalMsg(id, text, type) {
  const el = document.getElementById(id);
  el.textContent = text;
  el.className   = `modal-msg ${type}`;
  el.style.display = 'block';
}

function showToast(msg, type = 'success') {
  const t = document.getElementById('toast');
  t.textContent = (type === 'success' ? '‚úÖ ' : '‚ùå ') + msg;
  t.className   = `toast ${type} show`;
  setTimeout(() => t.classList.remove('show'), 3500);
}

function escHtml(str) {
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');
}

// Close modals on overlay click
document.querySelectorAll('.overlay').forEach(el => {
  el.addEventListener('click', e => { if (e.target === el) el.classList.remove('open'); });
});
</script>
</body>
</html>



